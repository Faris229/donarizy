<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background: #f3f4f6; display: flex; margin: 0; height: 100vh; }
        .sidebar { width: 250px; background: #1f2937; color: white; padding: 20px; }
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .menu { padding: 10px; cursor: pointer; color: #9ca3af; }
        .menu.active { color: white; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        input { padding: 8px; border: 1px solid #ccc; width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; background:#1f2937; display:flex; justify-content:center; align-items:center; z-index:999;">
        <div style="background:white; padding:30px; border-radius:10px; width:300px; text-align:center;">
            <h2>Admin Login</h2>
            <input id="adm-email" placeholder="Email (farisxuma1@gmail.com)">
            <input id="adm-pass" type="password" placeholder="Password">
            <button onclick="doLogin()" style="padding:10px; width:100%; background:#3b82f6; color:white; border:none; cursor:pointer;">Login</button>
        </div>
    </div>

    <div class="sidebar">
        <h3>Food Admin</h3>
        <div class="menu active" onclick="show('users')">จัดการผู้ใช้</div>
        <div class="menu" onclick="show('tx')">ธุรกรรมการเงิน</div>
    </div>

    <div class="main">
        <div id="p-users" class="card">
            <h3>รายชื่อผู้ใช้</h3>
            <div id="u-list">Loading...</div>
        </div>
        <div id="p-tx" class="card" style="display:none;">
            <h3>รายการรออนุมัติ</h3>
            <div id="tx-list">Loading...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        const config = { apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI", authDomain: "chat-27f96.firebaseapp.com", projectId: "chat-27f96" };
        firebase.initializeApp(config);
        const auth = firebase.auth(), db = firebase.firestore();
        let users = {};

        function doLogin() {
            auth.signInWithEmailAndPassword(document.getElementById('adm-email').value, document.getElementById('adm-pass').value)
                .then(() => document.getElementById('login-screen').style.display = 'none')
                .catch(e => alert(e.message));
        }

        auth.onAuthStateChanged(u => {
            if(u && u.email === 'farisxuma1@gmail.com') {
                document.getElementById('login-screen').style.display = 'none';
                loadData();
            }
        });

        function loadData() {
            db.collection('users').onSnapshot(snap => {
                let h = '<table><tr><th>Name</th><th>Role</th><th>Balance</th><th>Action</th></tr>';
                snap.forEach(d => {
                    const u = d.data(); users[d.id] = u;
                    h += `<tr><td>${u.username}</td><td>${u.role}</td><td>${u.balance.toFixed(2)}</td><td><button onclick="editBal('${d.id}')">แก้เงิน</button></td></tr>`;
                });
                document.getElementById('u-list').innerHTML = h+'</table>';
            });

            db.collection('transactions').where('status','==','pending').onSnapshot(snap => {
                let h = '<table><tr><th>Type</th><th>User</th><th>Amount</th><th>Action</th></tr>';
                snap.forEach(d => {
                    const t = d.data();
                    h += `<tr><td>${t.type}</td><td>${users[t.uid]?.username}</td><td>${t.amount}</td>
                    <td><button onclick="approve('${d.id}','${t.uid}',${t.amount},'${t.type}')">✔</button> <button onclick="reject('${d.id}')">✘</button></td></tr>`;
                });
                document.getElementById('tx-list').innerHTML = h+'</table>';
            });
        }

        async function editBal(uid) {
            const n = prompt("ยอดเงินใหม่:");
            if(n) await db.collection('users').doc(uid).update({balance:parseFloat(n)});
        }

        async function approve(id, uid, amt, type) {
            if(!confirm('ยืนยัน?')) return;
            await db.runTransaction(async t => {
                const uRef = db.collection('users').doc(uid);
                const bal = (await t.get(uRef)).data().balance;
                if(type==='withdraw' && bal<amt) throw "เงินไม่พอ";
                t.update(uRef, {balance: type==='deposit' ? bal+amt : bal-amt});
                t.update(db.collection('transactions').doc(id), {status:'approved'});
            });
        }

        async function reject(id) { await db.collection('transactions').doc(id).update({status:'rejected'}); }
        function show(p) { document.getElementById('p-users').style.display=p==='users'?'block':'none'; document.getElementById('p-tx').style.display=p==='tx'?'block':'none'; }
    </script>
</body>
</html>
