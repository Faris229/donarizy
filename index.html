<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-Space | Admin Console</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; }
        
        /* Table Styles */
        .q-table { width: 100%; text-align: left; border-collapse: separate; border-spacing: 0; }
        .q-table th { background: #f8fafc; padding: 1rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; border-bottom: 1px solid #e2e8f0; }
        .q-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; background: white; transition: background 0.1s; }
        .q-table tr:hover td { background: #f8fafc; }
        .q-table tr:last-child td { border-bottom: none; }
        .q-table th:first-child, .q-table td:first-child { padding-left: 1.5rem; }
        .q-table th:last-child, .q-table td:last-child { padding-right: 1.5rem; }

        /* Action Buttons */
        .btn-icon { width: 36px; height: 36px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-call { background: #eff6ff; color: #2563eb; } .btn-call:hover { background: #2563eb; color: white; }
        .btn-check { background: #ecfdf5; color: #059669; } .btn-check:hover { background: #059669; color: white; }
        .btn-del { background: #fef2f2; color: #dc2626; } .btn-del:hover { background: #dc2626; color: white; }

        /* Sidebar */
        .nav-item { display: flex; align-items: center; padding: 12px 16px; border-radius: 10px; color: #64748b; font-weight: 500; margin-bottom: 4px; transition: all 0.2s; }
        .nav-item:hover { background: #f8fafc; color: #0f172a; }
        .nav-item.active { background: #0f172a; color: white; }
        
        .stat-card { background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
            <span class="font-bold text-lg text-slate-800">Q-Space <span class="text-xs bg-slate-100 px-2 py-1 rounded ml-2">ADMIN</span></span>
        </div>
        <nav class="flex-1 p-4 overflow-y-auto">
            <button onclick="Admin.switchTab('live')" id="nav-live" class="nav-item active w-full text-left">
                <i class="fa-solid fa-list-ol w-6"></i> รายการคิวสด
            </button>
            <button onclick="Admin.switchTab('history')" id="nav-history" class="nav-item w-full text-left">
                <i class="fa-solid fa-clock-rotate-left w-6"></i> ประวัติวันนี้
            </button>
            <div class="mt-8 px-4 text-xs font-bold text-gray-400 uppercase">Controls</div>
            <button onclick="Admin.resetSystem()" class="nav-item w-full text-left text-red-500 hover:bg-red-50 hover:text-red-600">
                <i class="fa-solid fa-trash w-6"></i> รีเซ็ตคิว (วันใหม่)
            </button>
        </nav>
        <div class="p-4 border-t border-gray-100 text-xs text-center text-gray-400">
            Version 3.0 Enterprise
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full">
        
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8">
            <h2 class="font-bold text-xl text-slate-800" id="page-title">Live Queue Management</h2>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-xs text-gray-400 uppercase">Now Serving</div>
                    <div class="text-xl font-bold text-blue-600" id="header-current">A-000</div>
                </div>
            </div>
        </header>

        <div class="flex-1 p-8 overflow-y-auto bg-slate-50">
            
            <div class="grid grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="text-xs text-gray-400 font-bold uppercase">รอรับบริการ</div>
                    <div class="text-3xl font-bold text-slate-800 mt-1" id="stat-waiting">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs text-gray-400 font-bold uppercase">เรียกแล้ว</div>
                    <div class="text-3xl font-bold text-blue-600 mt-1" id="stat-called">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs text-gray-400 font-bold uppercase">เสร็จสิ้น</div>
                    <div class="text-3xl font-bold text-green-600 mt-1" id="stat-served">0</div>
                </div>
                <div class="stat-card border-red-200 bg-red-50">
                    <div class="text-xs text-red-400 font-bold uppercase">ยกเลิก</div>
                    <div class="text-3xl font-bold text-red-600 mt-1" id="stat-cancel">0</div>
                </div>
            </div>

            <div id="view-live" class="animate__animated animate__fadeIn">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="q-table">
                        <thead>
                            <tr>
                                <th>Queue No.</th>
                                <th>Customer Name</th>
                                <th>PAX</th>
                                <th>Wait Time</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-live">
                            </tbody>
                    </table>
                    <div id="empty-live" class="p-8 text-center text-gray-400 hidden">ไม่มีคิวที่กำลังรอ</div>
                </div>
            </div>

            <div id="view-history" class="hidden animate__animated animate__fadeIn">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="q-table">
                        <thead>
                            <tr>
                                <th>Queue No.</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="table-history">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>
<script>
        // --- 1. CONFIGURATION (ใส่ค่าของท่าน) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        // Initialize Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        class AdminApp {
            constructor() {
                // อ้างอิง Collection หลัก
                this.qRef = db.collection('q_system').doc('config').collection('queues');
                this.initListeners();
            }

            initListeners() {
                // 1. ฟังข้อมูลคิวทั้งหมด (แก้ไข: ดึงมาทั้งหมดแล้วค่อยกรอง เพื่อแก้ปัญหา Index Error)
                this.qRef.orderBy('timestamp', 'asc').onSnapshot(snap => {
                    
                    const allDocs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // แยกประเภทข้อมูล
                    const waiting = allDocs.filter(d => d.status === 'waiting');
                    const called = allDocs.filter(d => d.status === 'called');
                    const served = allDocs.filter(d => d.status === 'served');
                    const cancelled = allDocs.filter(d => d.status === 'cancelled');

                    // อัปเดตตัวเลข Dashboard
                    document.getElementById('stat-waiting').innerText = waiting.length;
                    document.getElementById('stat-called').innerText = called.length;
                    document.getElementById('stat-served').innerText = served.length;
                    document.getElementById('stat-cancel').innerText = cancelled.length;

                    // ส่งข้อมูลไปวาดตาราง (รวม Waiting และ Called ไว้หน้า Live)
                    this.renderLiveTable([...called, ...waiting]); // เอา Called ขึ้นก่อน
                    
                    // ส่งข้อมูลไปหน้าประวัติ (Served + Cancelled)
                    // กลับด้าน array ให้ประวัติล่าสุดอยู่บน
                    this.renderHistoryTable([...served, ...cancelled].reverse());
                }, error => {
                    console.error("Error loading queues:", error);
                    Swal.fire("Connection Error", "ไม่สามารถดึงข้อมูลได้: " + error.message, "error");
                });

                // 2. ฟังคิวปัจจุบัน (Header)
                db.collection('q_system').doc('config').onSnapshot(doc => {
                    if(doc.exists) document.getElementById('header-current').innerText = doc.data().current || 'A-000';
                });
            }

            renderLiveTable(data) {
                const tbody = document.getElementById('table-live');
                const empty = document.getElementById('empty-live');
                tbody.innerHTML = '';
                
                if(data.length === 0) { 
                    empty.classList.remove('hidden'); 
                    return; 
                } else {
                    empty.classList.add('hidden');
                }

                data.forEach(d => {
                    const isCalled = d.status === 'called';
                    // แปลง Timestamp เป็นเวลา
                    const time = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : '-';
                    
                    const rowClass = isCalled ? 'bg-blue-50 border-l-4 border-blue-500' : 'hover:bg-gray-50';
                    const statusBadge = isCalled 
                        ? `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold animate-pulse">กำลังเรียก</span>` 
                        : `<span class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs">รอคิว</span>`;

                    tbody.innerHTML += `
                        <tr class="${rowClass} transition-colors duration-200">
                            <td class="p-4">
                                <span class="font-bold text-xl ${isCalled ? 'text-blue-600' : 'text-slate-700'}">${d.number}</span>
                                <div class="mt-1">${statusBadge}</div>
                            </td>
                            <td class="p-4">
                                <div class="font-bold text-slate-700">${d.name}</div>
                                <div class="text-xs text-gray-400"><i class="fa-solid fa-phone mr-1"></i>${d.phone || '-'}</div>
                            </td>
                            <td class="p-4"><span class="bg-white border border-gray-200 text-gray-600 px-3 py-1 rounded-lg text-sm font-bold shadow-sm">${d.pax} ท่าน</span></td>
                            <td class="p-4 text-sm text-gray-500 font-mono">${time}</td>
                            <td class="p-4 text-right">
                                <div class="flex justify-end gap-2">
                                    <button onclick="Admin.call('${d.id}', '${d.number}')" class="btn-icon btn-call shadow-sm" title="เรียกคิว"><i class="fa-solid fa-bullhorn"></i></button>
                                    <button onclick="Admin.serve('${d.id}')" class="btn-icon btn-check shadow-sm" title="เสร็จสิ้น"><i class="fa-solid fa-check"></i></button>
                                    <button onclick="Admin.cancel('${d.id}')" class="btn-icon btn-del shadow-sm" title="ยกเลิก"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }

            renderHistoryTable(data) {
                const tbody = document.getElementById('table-history');
                tbody.innerHTML = '';
                
                if(data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400">ยังไม่มีประวัติวันนี้</td></tr>';
                    return;
                }

                data.forEach(d => {
                    const isServed = d.status === 'served';
                    const color = isServed ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
                    const label = isServed ? 'เสร็จสิ้น' : 'ยกเลิก';
                    const time = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleTimeString('th-TH') : '-';

                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="p-4 font-bold text-slate-600">${d.number}</td>
                            <td class="p-4 text-slate-600">${d.name}</td>
                            <td class="p-4"><span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${color}">${label}</span></td>
                            <td class="p-4 text-sm text-gray-400 font-mono">${time}</td>
                        </tr>
                    `;
                });
            }

            // --- ACTIONS ---
            call(id, num) {
                // อัปเดตสถานะคิวเป็น 'called'
                this.qRef.doc(id).update({ status: 'called' });
                // อัปเดตเลขปัจจุบันที่ Config หลัก (เพื่อให้หน้าลูกค้าเห็น)
                db.collection('q_system').doc('config').update({ current: num });
                // พูดชื่อ
                this.speak(`ขอเชิญหมายเลข ${num} ค่ะ`);
            }

            serve(id) {
                this.qRef.doc(id).update({ status: 'served' });
            }

            cancel(id) {
                Swal.fire({
                    title: 'ยกเลิกคิวนี้?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc2626',
                    confirmButtonText: 'ยืนยัน'
                }).then((r) => {
                    if(r.isConfirmed) this.qRef.doc(id).update({ status: 'cancelled' });
                });
            }

            resetSystem() {
                Swal.fire({
                    title: 'รีเซ็ตระบบ (วันใหม่)?',
                    text: "คิวทั้งหมดจะถูกลบและเริ่มนับ 1 ใหม่",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'ยืนยันรีเซ็ต'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        // 1. Reset Config
                        await db.collection('q_system').doc('config').set({ current: 'A-000', last: 0 });
                        
                        // 2. Delete All Queues (Client-side Batch Delete)
                        const snap = await this.qRef.get();
                        const batch = db.batch();
                        snap.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();

                        Swal.fire('เรียบร้อย', 'ระบบพร้อมสำหรับวันใหม่', 'success');
                    }
                });
            }

            speak(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'th-TH';
                    utterance.rate = 0.9;
                    speechSynthesis.speak(utterance);
                }
            }

            switchTab(tab) {
                document.getElementById('view-live').classList.add('hidden');
                document.getElementById('view-history').classList.add('hidden');
                document.getElementById(`view-${tab}`).classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                document.getElementById(`nav-${tab}`).classList.add('active');
            }
        }

        // Start Admin App
        const Admin = new AdminApp();
    </script>
</body>
</html>

