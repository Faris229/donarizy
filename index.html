<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin - FoodRunner</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background: #f8f9fa; display: flex; }
        .sidebar { width: 250px; background: #2f3542; color: white; height: 100vh; padding: 20px; }
        .main { flex: 1; padding: 20px; overflow-y: auto; height: 100vh; }
        .menu-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #57606f; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { padding: 5px 10px; cursor: pointer; color: white; border: none; border-radius: 5px; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Admin Panel</h3>
        <div class="menu-item" onclick="show('tx')">ธุรกรรมการเงิน</div>
        <div class="menu-item" onclick="show('users')">จัดการผู้ใช้</div>
        <div class="menu-item" onclick="show('support')">Support Chat</div>
    </div>
    
    <div class="main">
        <div id="p-tx" class="card"><h3>รายการรออนุมัติ</h3><div id="tx-list"></div></div>
        <div id="p-users" class="card" style="display:none;"><h3>ผู้ใช้ทั้งหมด</h3><div id="user-list"></div></div>
        <div id="p-support" class="card" style="display:none;"><h3>แจ้งปัญหา</h3><div id="support-list"></div></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        auth.onAuthStateChanged(u => {
            if(!u) {
                const e = prompt("Admin Email"); const p = prompt("Password");
                auth.signInWithEmailAndPassword(e, p);
            } else init();
        });

        function init() {
            // Transactions
            db.collection('transactions').where('status','==','pending').onSnapshot(snap => {
                let h = '<table width="100%"><tr><th>Type</th><th>Amount</th><th>User</th><th>Action</th></tr>';
                snap.forEach(d => {
                    const t = d.data();
                    h += `<tr>
                        <td>${t.type}</td>
                        <td>${t.amount} (Fee: ${t.fee||0})</td>
                        <td>${t.uid}</td>
                        <td>
                            <button class="btn" style="background:green" onclick="approveTx('${d.id}','${t.uid}',${t.amount},'${t.type}',${t.total||t.amount})">✔</button>
                            <button class="btn" style="background:red" onclick="rejectTx('${d.id}')">✘</button>
                        </td>
                    </tr>`;
                });
                document.getElementById('tx-list').innerHTML = h + '</table>';
            });

            // Users
            db.collection('users').onSnapshot(snap => {
                let h = '<table width="100%"><tr><th>Name</th><th>Phone</th><th>Balance</th><th>Edit</th></tr>';
                snap.forEach(d => {
                    const u = d.data();
                    h += `<tr>
                        <td>${u.username}</td><td>${u.phone}</td><td>${u.balance}</td>
                        <td><button class="btn" style="background:blue" onclick="editBal('${d.id}', ${u.balance})">Edit Bal</button></td>
                    </tr>`;
                });
                document.getElementById('user-list').innerHTML = h + '</table>';
            });

            // Support
            db.collection('support').orderBy('timestamp','desc').onSnapshot(snap => {
                let h = '';
                snap.forEach(d => {
                    const s = d.data();
                    h += `<div style="border-bottom:1px solid #eee; padding:10px;">
                        <b>User:</b> ${s.message}<br>
                        ${s.reply ? `<b style="color:blue">Admin: ${s.reply}</b>` : `<button class="btn" style="background:#ffa502" onclick="reply('${d.id}')">ตอบกลับ</button>`}
                    </div>`;
                });
                document.getElementById('support-list').innerHTML = h;
            });
        }

        async function approveTx(id, uid, amt, type, totalDeduct) {
            if(!confirm('ยืนยัน?')) return;
            await db.runTransaction(async t => {
                const uRef = db.collection('users').doc(uid);
                const txRef = db.collection('transactions').doc(id);
                const uDoc = await t.get(uRef);
                let bal = uDoc.data().balance;

                if(type === 'deposit') bal += amt;
                else bal -= totalDeduct;

                t.update(uRef, {balance: bal});
                t.update(txRef, {status: 'approved'});
            });
        }

        async function rejectTx(id) { await db.collection('transactions').doc(id).update({status:'rejected'}); }
        
        async function editBal(uid, old) {
            const {value: n} = await Swal.fire({title:'แก้เงิน', input:'number', inputValue:old});
            if(n) await db.collection('users').doc(uid).update({balance: parseFloat(n)});
        }

        async function reply(id) {
            const {value: txt} = await Swal.fire({title:'ตอบกลับ', input:'text'});
            if(txt) await db.collection('support').doc(id).update({reply: txt, status:'replied'});
        }

        function show(id) {
            ['p-tx','p-users','p-support'].forEach(e => document.getElementById(e).style.display='none');
            document.getElementById('p-'+id).style.display='block';
        }
    </script>
</body>
</html>
