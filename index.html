<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Bank | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', sans-serif; background: #dfe6e9; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stat-val { font-size: 2rem; font-weight: bold; color: #2d3436; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; background: #f1f2f6; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .btn-sm { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; color: white; margin-right: 5px; }
        .btn-approve { background: #00b894; }
        .btn-reject { background: #d63031; }
        .btn-slip { background: #0984e3; }
        
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: #eee; font-weight: bold; }
        .tab-btn.active { background: white; border-top: 3px solid #00b894; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2>üè¶ Admin Money Control</h2>
            <button class="btn-sm btn-reject" onclick="auth.signOut()">Logout</button>
        </div>

        <div class="stat-grid">
            <div class="card">
                <div>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="stat-val" id="stat-users">0</div>
            </div>
            <div class="card">
                <div>‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏°</div>
                <div class="stat-val" id="stat-money">0 ‡∏ø</div>
            </div>
        </div>

        <div class="card">
            <div style="margin-bottom:15px;">
                <button class="tab-btn active" onclick="loadTx('deposit')">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</button>
                <button class="tab-btn" onclick="loadTx('withdraw')">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</button>
            </div>
            <div id="tx-table">Loading...</div>
        </div>
        
        <div class="card">
            <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
            <div id="user-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23",
            measurementId: "G-GR38B5JHZZ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(user => {
            if(!user) { alert('Login First!'); window.location.href='index.html'; }
            else { loadStats(); loadTx('deposit'); }
        });

        async function loadStats() {
            const snap = await db.collection('users').get();
            document.getElementById('stat-users').innerText = snap.size;
            let total = 0;
            let userHtml = '<table><tr><th>User</th><th>Email</th><th>Balance</th><th>Action</th></tr>';
            snap.forEach(doc => {
                const u = doc.data();
                total += (u.balance || 0);
                userHtml += `<tr><td>${u.username}</td><td>${u.email}</td><td>${(u.balance||0).toFixed(2)}</td><td><button class="btn-sm btn-reject" onclick="resetPass('${u.email}')">Reset Pass</button></td></tr>`;
            });
            document.getElementById('stat-money').innerText = total.toFixed(2) + ' ‡∏ø';
            document.getElementById('user-list').innerHTML = userHtml + '</table>';
        }

        function loadTx(type) {
            // Update Tab UI
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            db.collection('transactions')
                .where('type', '==', type)
                .where('status', '==', 'pending')
                .onSnapshot(snap => {
                    let html = '<table><tr><th>User</th><th>Amount</th><th>Time</th><th>Action</th></tr>';
                    if(snap.empty) html = '<div style="padding:20px;text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</div>';
                    else {
                        snap.forEach(doc => {
                            const t = doc.data();
                            let extra = t.type === 'deposit' 
                                ? `<button class="btn-sm btn-slip" onclick="window.open('${t.slipURL}')">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</button>`
                                : `<span style="color:red; font-size:0.8rem;">(‡∏´‡∏±‡∏Å ${t.totalDeduct})</span>`;
                            
                            html += `
                                <tr>
                                    <td>${t.email}</td>
                                    <td>${t.amount} ${extra}</td>
                                    <td>${new Date(t.timestamp.seconds*1000).toLocaleString()}</td>
                                    <td>
                                        <button class="btn-sm btn-approve" onclick="processTx('${doc.id}', '${t.uid}', ${t.amount}, '${t.type}', ${t.totalDeduct})">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        <button class="btn-sm btn-reject" onclick="rejectTx('${doc.id}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                    </td>
                                </tr>
                            `;
                        });
                        html += '</table>';
                    }
                    document.getElementById('tx-table').innerHTML = html;
                });
        }

        async function processTx(txId, uid, amount, type, withdrawTotal) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?')) return;

            try {
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(uid);
                    const txRef = db.collection('transactions').doc(txId);
                    
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist!";
                    
                    let newBalance = userDoc.data().balance || 0;

                    if (type === 'deposit') {
                        newBalance += amount;
                    } else if (type === 'withdraw') {
                        if (newBalance < withdrawTotal) throw "‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏≠‡∏ô!";
                        newBalance -= withdrawTotal;
                    }

                    transaction.update(userRef, { balance: newBalance });
                    transaction.update(txRef, { status: 'approved' });
                });
                
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
                loadStats(); // Refresh stats
            } catch (e) {
                Swal.fire('Error', e.toString(), 'error');
            }
        }

        async function rejectTx(txId) {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?')) {
                await db.collection('transactions').doc(txId).update({ status: 'rejected' });
            }
        }

        async function resetPass(email) {
            if(confirm(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ ${email}?`)) {
                await auth.sendPasswordResetEmail(email);
                alert('‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
            }
        }
    </script>
</body>
</html>
