<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - จัดการหลังบ้าน</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background: #1e293b; color: white; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        
        .card { background: #334155; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .user-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; }
        
        .task-list { background: #0f172a; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .task-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #1e293b; color: #cbd5e1; }
        .task-item:last-child { border-bottom: none; }
        
        .btn-del { background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .bg-green { background: #10b981; }
        .bg-red { background: #ef4444; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2><i class="fa-solid fa-user-secret"></i> แอดมินคอนโซล</h2>
            <button onclick="checkData()" style="padding:10px; border-radius:8px; cursor:pointer;">รีเฟรชข้อมูล</button>
        </div>

        <div id="loading" style="text-align:center;">กำลังโหลดข้อมูลจาก Firebase...</div>
        <div id="content-area"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- 1. CONFIG (เอาอันเดิมของคุณมาใส่ตรงนี้นะครับ!!) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23",
            measurementId: "G-GR38B5JHZZ"
        };
        
        // เริ่มต้น Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- Logic ดึงข้อมูลทั้งหมด ---
        async function checkData() {
            const content = document.getElementById('content-area');
            const loading = document.getElementById('loading');
            content.innerHTML = '';
            loading.style.display = 'block';

            try {
                // 1. ดึงรายชื่อ User ทั้งหมด
                const usersSnap = await db.collection('users').get();
                
                if (usersSnap.empty) {
                    loading.style.display = 'none';
                    content.innerHTML = '<p>ยังไม่มีผู้ใช้งาน</p>';
                    return;
                }

                // 2. วนลูป User แต่ละคนเพื่อดึงงาน
                for (const userDoc of usersSnap.docs) {
                    const user = userDoc.data();
                    const userId = userDoc.id;

                    // ดึงงานของ User คนนี้
                    const tasksSnap = await db.collection('homeworks').doc(userId).collection('items').get();
                    
                    let taskHTML = '<div class="task-list">';
                    if(tasksSnap.empty) {
                        taskHTML += '<div style="padding:10px; color:#64748b;">- ไม่มีรายการงาน -</div>';
                    } else {
                        tasksSnap.forEach(taskDoc => {
                            const t = taskDoc.data();
                            taskHTML += `
                                <div class="task-item">
                                    <span>${t.subject} (${t.content})</span>
                                    <div>
                                        <span class="badge ${t.isCompleted ? 'bg-green' : 'bg-red'}">
                                            ${t.isCompleted ? 'เสร็จ' : 'ค้าง'}
                                        </span>
                                        <button class="btn-del" onclick="adminDelete('${userId}', '${taskDoc.id}')">ลบ</button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    taskHTML += '</div>';

                    // สร้าง Card ผู้ใช้
                    const userCard = document.createElement('div');
                    userCard.className = 'card';
                    userCard.innerHTML = `
                        <div class="user-header">
                            <img src="${user.photoURL}" class="avatar">
                            <div>
                                <div style="font-weight:bold; font-size:1.1rem;">${user.username}</div>
                                <div style="font-size:0.8rem; color:#94a3b8;">${user.email}</div>
                            </div>
                        </div>
                        ${taskHTML}
                    `;
                    content.appendChild(userCard);
                }
                loading.style.display = 'none';

            } catch (error) {
                loading.innerText = 'เกิดข้อผิดพลาด: ' + error.message;
                console.error(error);
            }
        }

        // ฟังก์ชันลบงาน (ในฐานะแอดมิน)
        async function adminDelete(userId, taskId) {
            if(confirm('แอดมินต้องการลบงานนี้ใช่ไหม?')) {
                await db.collection('homeworks').doc(userId).collection('items').doc(taskId).delete();
                alert('ลบเรียบร้อย');
                checkData(); // รีโหลดหน้าจอ
            }
        }

        // เริ่มทำงานทันที
        checkData();

    </script>
</body>
</html>
