<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Commander | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏û</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f8fafc;
            --sidebar-bg: #0f172a;
            --primary: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #334155;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg-body); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text-main); }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: #0f172a; z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 15px; font-family: inherit; }

        /* Layout */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: #94a3b8; padding: 20px; display: flex; flex-direction: column; transition: 0.3s; }
        .brand { color: white; font-size: 1.5rem; font-weight: 700; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 10px; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .badge-count { background: var(--danger); color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; margin-left: auto; }

        .main { flex: 1; padding: 30px; overflow-y: auto; background: #f1f5f9; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .admin-profile { display: flex; align-items: center; gap: 10px; background: white; padding: 8px 15px; border-radius: 50px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* Cards & Grids */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-left: 5px solid var(--primary); }
        .stat-val { font-size: 1.8rem; font-weight: 700; margin-top: 5px; color: var(--sidebar-bg); }
        .stat-label { font-size: 0.9rem; color: #64748b; }

        .content-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 25px; }

        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        /* Transaction Items */
        .tx-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .tx-item:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        .bank-box { background: #ecfdf5; color: #065f46; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; margin-top: 8px; display: inline-block; border: 1px solid #a7f3d0; }
        
        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; color: white; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Chat */
        .chat-box { max-height: 400px; overflow-y: auto; }
        .chat-msg { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="margin-bottom:20px; color:var(--sidebar-bg);">Admin Commander</h2>
            <input type="email" id="admin-email" value="farisxuma1@gmail.com" readonly style="background:#f1f5f9; cursor:not-allowed;">
            <input type="password" id="admin-pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="app-panel" style="display:none; width:100%; height:100%;">
        
        <aside class="sidebar">
            <div class="brand"><i class="fa-solid fa-user-secret"></i> SUPER ADMIN</div>
            <div class="menu-item active" onclick="switchTab('dash', this)"><i class="fa-solid fa-chart-line"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            <div class="menu-item" onclick="switchTab('deposit', this)"><i class="fa-solid fa-circle-down"></i> ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô <span id="badge-dep" class="badge-count hidden">0</span></div>
            <div class="menu-item" onclick="switchTab('withdraw', this)"><i class="fa-solid fa-circle-up"></i> ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô <span id="badge-wit" class="badge-count hidden">0</span></div>
            <div class="menu-item" onclick="switchTab('users', this)"><i class="fa-solid fa-users"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
            <div class="menu-item" onclick="switchTab('chat', this)"><i class="fa-solid fa-comments"></i> ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <div class="menu-item" onclick="switchTab('history', this)"><i class="fa-solid fa-clock-rotate-left"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
            
            <div style="margin-top:auto;">
                <button class="btn btn-danger" style="width:100%;" onclick="auth.signOut()"><i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </aside>

        <main class="main">
            <div class="header">
                <h2 id="page-title">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
                <div class="admin-profile">
                    <i class="fa-solid fa-circle-user" style="font-size:1.5rem; color:var(--primary);"></i>
                    <span>farisxuma1</span>
                </div>
            </div>

            <div id="tab-dash">
                <div class="stats-grid">
                    <div class="stat-card" style="border-color:#4f46e5;">
                        <div class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="stat-val" id="st-total-bal">0 ‡∏ø</div>
                    </div>
                    <div class="stat-card" style="border-color:#10b981;">
                        <div class="stat-label">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="stat-val" id="st-users">0</div>
                    </div>
                    <div class="stat-card" style="border-color:#f59e0b;">
                        <div class="stat-label">‡∏£‡∏≠‡∏ù‡∏≤‡∏Å</div>
                        <div class="stat-val" id="st-p-dep">0</div>
                    </div>
                    <div class="stat-card" style="border-color:#ef4444;">
                        <div class="stat-label">‡∏£‡∏≠‡∏ñ‡∏≠‡∏ô</div>
                        <div class="stat-val" id="st-p-wit">0</div>
                    </div>
                </div>
                
                <div class="content-card">
                    <h3>üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</h3>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</p>
                </div>
            </div>

            <div id="tab-deposit" style="display:none;">
                <div class="content-card">
                    <h3>üì• ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ù‡∏≤‡∏Å (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</h3>
                    <p style="color:#64748b; font-size:0.9rem;">*‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏≤‡∏Å‡πÅ‡∏ä‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                    <div id="list-deposit">Loading...</div>
                </div>
            </div>

            <div id="tab-withdraw" style="display:none;">
                <div class="content-card">
                    <h3>üì§ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</h3>
                    <p style="color:#ef4444; font-size:0.9rem;">*‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏≠‡∏ô</p>
                    <div id="list-withdraw">Loading...</div>
                </div>
            </div>

            <div id="tab-users" style="display:none;">
                <div class="content-card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <button class="btn btn-primary" onclick="loadUsers()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="user-table">
                            <thead><tr><th>User</th><th>Bank Info</th><th>Balance</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-chat" style="display:none;">
                <div class="content-card">
                    <h3>üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                    <div id="chat-list" class="chat-box">Loading...</div>
                </div>
            </div>

            <div id="tab-history" style="display:none;">
                <div class="content-card">
                    <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß)</h3>
                    <div id="history-list">Loading...</div>
                </div>
            </div>

        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // AUTH CHECK
        auth.onAuthStateChanged(user => {
            if(user) {
                if(user.email !== 'farisxuma1@gmail.com') {
                    Swal.fire('Access Denied','‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô','error').then(()=>auth.signOut());
                    return;
                }
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-panel').style.display = 'flex';
                initData();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        async function adminLogin() {
            try {
                await auth.signInWithEmailAndPassword(
                    document.getElementById('admin-email').value,
                    document.getElementById('admin-pass').value
                );
            } catch(e) { Swal.fire('Error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
        }

        function initData() {
            loadUsers();
            loadTransactions();
            loadChats();
        }

        // --- USERS & STATS ---
        async function loadUsers() {
            const tbody = document.querySelector('#user-table tbody');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            
            db.collection('users').onSnapshot(snap => {
                document.getElementById('st-users').innerText = snap.size;
                let total = 0;
                tbody.innerHTML = '';

                snap.forEach(doc => {
                    const u = doc.data();
                    const uid = doc.id;
                    total += (u.balance || 0);

                    let bankHtml = u.bankName ? `<small><b>${u.bankName}</b><br>${u.bankNo}<br>${u.bankAccName}</small>` : '<span style="color:#ccc;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å</span>';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:bold;">${u.username}</div>
                            <div style="font-size:0.8rem; color:#64748b;">${u.email}</div>
                        </td>
                        <td>${bankHtml}</td>
                        <td style="font-weight:bold; color:${u.balance>0?'#10b981':'#334155'}">${(u.balance||0).toLocaleString()} ‡∏ø</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="adjustBalance('${uid}', ${u.balance||0})">‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î</button>
                            <button class="btn btn-sm btn-danger" onclick="resetPass('${u.email}')">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('st-total-bal').innerText = total.toLocaleString() + ' ‡∏ø';
            });
        }

        // --- TRANSACTIONS ---
        function loadTransactions() {
            db.collection('transactions').onSnapshot(snap => {
                const listDep = document.getElementById('list-deposit');
                const listWit = document.getElementById('list-withdraw');
                const listHis = document.getElementById('history-list');

                listDep.innerHTML = ''; listWit.innerHTML = ''; listHis.innerHTML = '';
                
                let pDep=0, pWit=0;

                // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á (‡πÄ‡∏Å‡πà‡∏≤ -> ‡πÉ‡∏´‡∏°‡πà ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pending, ‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö History)
                let items = [];
                snap.forEach(doc => items.push({id:doc.id, ...doc.data()}));
                
                // Pending: ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô)
                let pendings = items.filter(i => i.status === 'pending').sort((a,b) => (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0));
                
                // History: ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
                let history = items.filter(i => i.status !== 'pending').sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));

                // Render Pending
                if(pendings.length === 0) {
                    listDep.innerHTML = '<p style="color:#ccc">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                    listWit.innerHTML = '<p style="color:#ccc">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                }

                pendings.forEach(t => {
                    let time = t.timestamp ? new Date(t.timestamp.seconds*1000).toLocaleString() : '...';
                    
                    if(t.type === 'deposit') {
                        pDep++;
                        listDep.innerHTML += `
                            <div class="tx-item">
                                <div>
                                    <div style="font-weight:bold;">${t.email}</div>
                                    <div style="font-size:0.85rem; color:#64748b;">${time}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:1.5rem; font-weight:bold; color:#10b981;">+${t.amount.toLocaleString()} ‡∏ø</div>
                                    <div style="margin-top:5px;">
                                        <button class="btn btn-sm btn-success" onclick="processTx('${t.id}','${t.uid}',${t.amount},'deposit',0,'${t.email}')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectTx('${t.id}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        pWit++;
                        listWit.innerHTML += `
                            <div class="tx-item">
                                <div>
                                    <div style="font-weight:bold;">${t.email}</div>
                                    <div style="font-size:0.85rem; color:#64748b;">${time}</div>
                                    <div class="bank-box">
                                        üè¶ <b>${t.bankName}</b><br>
                                        ‡πÄ‡∏•‡∏Ç: ${t.bankNo}<br>
                                        ‡∏ä‡∏∑‡πà‡∏≠: ${t.bankAccName}
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:1.5rem; font-weight:bold; color:#ef4444;">-${t.amount.toLocaleString()} ‡∏ø</div>
                                    <div style="font-size:0.8rem; color:red;">(‡∏´‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á ${t.totalDeduct})</div>
                                    <div style="margin-top:5px;">
                                        <button class="btn btn-sm btn-success" onclick="processTx('${t.id}','${t.uid}',${t.amount},'withdraw',${t.totalDeduct},'${t.email}')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectTx('${t.id}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                // Render History (Max 20)
                history.slice(0, 20).forEach(t => {
                    let color = t.type==='deposit' ? '#10b981' : '#ef4444';
                    let sign = t.type==='deposit' ? '+' : '-';
                    let stColor = t.status==='approved' ? 'green' : 'red';
                    
                    listHis.innerHTML += `
                        <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                            <div>
                                <b>${t.email}</b> <small style="color:#888">(${t.type})</small><br>
                                <span style="font-size:0.8rem;">${new Date(t.timestamp.seconds*1000).toLocaleString()}</span>
                            </div>
                            <div style="text-align:right;">
                                <b style="color:${color}">${sign}${t.amount}</b><br>
                                <b style="color:${stColor}; font-size:0.8rem;">${t.status.toUpperCase()}</b>
                            </div>
                        </div>
                    `;
                });

                // Update Badges
                document.getElementById('st-p-dep').innerText = pDep;
                document.getElementById('st-p-wit').innerText = pWit;
                
                const bDep = document.getElementById('badge-dep');
                const bWit = document.getElementById('badge-wit');
                if(pDep>0) { bDep.innerText=pDep; bDep.classList.remove('hidden'); } else bDep.classList.add('hidden');
                if(pWit>0) { bWit.innerText=pWit; bWit.classList.remove('hidden'); } else bWit.classList.add('hidden');
            });
        }

        // --- CORE LOGIC (Approve/Reject/Adjust) ---

        // 1. Approve Transaction
        async function processTx(txId, uid, amount, type, withdrawTotal, email) {
            const { isConfirmed } = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?',
                text: type==='withdraw' ? `‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${amount} ‡∏ö‡∏≤‡∏ó ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î` : '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏•‡∏¢',
                confirmButtonColor: '#10b981'
            });

            if(!isConfirmed) return;

            try {
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(uid);
                    const txRef = db.collection('transactions').doc(txId);
                    const userDoc = await transaction.get(userRef);

                    // Auto-fix User Not Found
                    let currentBal = 0;
                    if(!userDoc.exists) {
                        if(type==='withdraw') throw "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)";
                        transaction.set(userRef, { username: 'Recovered User', email: email, balance: 0, createdAt: new Date() });
                    } else {
                        currentBal = userDoc.data().balance || 0;
                    }

                    let newBal = currentBal;
                    if(type === 'deposit') newBal += amount;
                    else {
                        if(currentBal < withdrawTotal) throw "‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠";
                        newBal -= withdrawTotal;
                    }

                    transaction.update(userRef, { balance: newBal });
                    transaction.update(txRef, { status: 'approved' });
                });
                Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch(e) { Swal.fire('Error', e.toString(), 'error'); }
        }

        // 2. Reject Transaction
        async function rejectTx(id) {
            const { isConfirmed } = await Swal.fire({
                title: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?',
                text: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444'
            });
            if(isConfirmed) {
                await db.collection('transactions').doc(id).update({ status: 'rejected' });
                Swal.fire('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß','','success');
            }
        }

        // 3. Manual Balance Adjustment (New Feature!)
        async function adjustBalance(uid, current) {
            const { value: amt } = await Swal.fire({
                title: '‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠',
                text: `‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${current}`,
                input: 'number',
                inputPlaceholder: '‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£',
                showCancelButton: true
            });

            if(amt) {
                await db.collection('users').doc(uid).update({ balance: parseFloat(amt) });
                Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠ ${amt}`, 'success');
            }
        }

        // --- SUPPORT CHAT ---
        function loadChats() {
            db.collection('reports').where('status','==','pending').onSnapshot(snap => {
                const list = document.getElementById('chat-list');
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p style="color:#ccc">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</p>'; return; }
                
                snap.forEach(doc => {
                    const t = doc.data();
                    list.innerHTML += `
                        <div class="chat-msg">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <b>${t.email}</b>
                                <small>${new Date(t.timestamp.seconds*1000).toLocaleString()}</small>
                            </div>
                            <div style="margin-bottom:10px;">${t.message}</div>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="rep-${doc.id}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö..." style="margin:0; flex:1;">
                                <button class="btn btn-primary" onclick="reply('${doc.id}')">‡∏™‡πà‡∏á</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        async function reply(id) {
            const msg = document.getElementById('rep-'+id).value;
            if(!msg) return;
            await db.collection('reports').doc(id).update({ status:'done', adminReply:msg });
            Swal.fire('‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß','','success');
        }

        async function resetPass(email) {
            if(confirm('‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ '+email+'?')) {
                try {
                    await auth.sendPasswordResetEmail(email);
                    Swal.fire('‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß','','success');
                } catch(e){ Swal.fire('Error',e.message,'error'); }
            }
        }

        function switchTab(t, el) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
            ['dash','deposit','withdraw','users','chat','history'].forEach(k => document.getElementById('tab-'+k).style.display='none');
            document.getElementById('tab-'+t).style.display='block';
            document.getElementById('page-title').innerText = el.innerText;
        }
    </script>
</body>
</html>
