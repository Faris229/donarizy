<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin Food</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background: #f8f9fa; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .btn { padding: 5px 10px; border-radius: 5px; border: none; color: white; cursor: pointer; }
        .btn-green { background: #2ed573; } .btn-red { background: #ff4757; }
    </style>
</head>
<body>
    <h2>Admin Panel</h2>
    
    <div class="card">
        <h3>ธุรกรรมการเงิน (รออนุมัติ)</h3>
        <div id="tx-list"></div>
    </div>

    <div class="card">
        <h3>รายชื่อผู้ใช้ & ข้อมูลธนาคาร</h3>
        <div id="user-list"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        auth.onAuthStateChanged(u => {
            if(u && u.email === 'admin@food.com') init();
            else {
                const p = prompt("Admin Password");
                auth.signInWithEmailAndPassword('admin@food.com', p);
            }
        });

        function init() {
            // Users
            db.collection('users').onSnapshot(snap => {
                let h = '<table><tr><th>Name</th><th>Role</th><th>Bank</th><th>Account No.</th><th>Balance</th></tr>';
                snap.forEach(d => {
                    const u = d.data();
                    h += `<tr>
                        <td>${u.username}<br><small>${u.email}</small></td>
                        <td>${u.role}</td>
                        <td>${u.bankName || '-'}</td>
                        <td>${u.bankNo || '-'}</td>
                        <td>${u.balance.toFixed(2)}</td>
                    </tr>`;
                });
                document.getElementById('user-list').innerHTML = h + '</table>';
            });

            // Transactions
            db.collection('transactions').where('status','==','pending').onSnapshot(snap => {
                let h = '<table><tr><th>Type</th><th>User ID</th><th>Amount</th><th>Bank Info</th><th>Action</th></tr>';
                snap.forEach(async d => {
                    const t = d.data();
                    const uDoc = await db.collection('users').doc(t.uid).get();
                    const u = uDoc.data();
                    const bankInfo = t.type==='withdraw' ? `${u.bankName} - ${u.bankNo}` : '-';
                    
                    h += `<tr>
                        <td>${t.type}</td>
                        <td>${u.username}</td>
                        <td>${t.amount}</td>
                        <td>${bankInfo}</td>
                        <td>
                            <button class="btn btn-green" onclick="approve('${d.id}','${t.uid}',${t.amount},'${t.type}',${t.fee||0})">Approve</button>
                            <button class="btn btn-red" onclick="reject('${d.id}')">Reject</button>
                        </td>
                    </tr>`;
                    document.getElementById('tx-list').innerHTML = h + '</table>';
                });
            });
        }

        async function approve(txId, uid, amt, type, fee) {
            if(!confirm('ยืนยัน?')) return;
            await db.runTransaction(async t => {
                const uRef = db.collection('users').doc(uid);
                const uDoc = await t.get(uRef);
                let bal = uDoc.data().balance;
                
                if(type === 'deposit') bal += amt;
                else {
                    if(bal < amt + fee) throw "เงินไม่พอ";
                    bal -= (amt + fee);
                }
                
                t.update(uRef, {balance: bal});
                t.update(db.collection('transactions').doc(txId), {status: 'approved'});
            });
        }
        
        async function reject(id) {
            await db.collection('transactions').doc(id).update({status:'rejected'});
        }
    </script>
</body>
</html>
