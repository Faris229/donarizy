<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Wheel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body class="flex h-screen bg-gray-100 font-sans">

    <aside class="w-64 bg-white border-r flex flex-col">
        <div class="p-6 font-bold text-xl text-purple-600 border-b">Admin Panel</div>
        <nav class="p-4 space-y-1">
            <button onclick="show('prizes')" class="w-full text-left p-3 rounded hover:bg-purple-50 text-gray-700 font-bold"><i class="fa-solid fa-gift w-6"></i> ของรางวัล</button>
            <button onclick="show('codes')" class="w-full text-left p-3 rounded hover:bg-purple-50 text-gray-700 font-bold"><i class="fa-solid fa-ticket w-6"></i> โค้ด</button>
            <button onclick="show('chat')" class="w-full text-left p-3 rounded hover:bg-purple-50 text-gray-700 font-bold"><i class="fa-solid fa-comments w-6"></i> แชท</button>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        
        <div id="prizes" class="section">
            <h2 class="text-2xl font-bold mb-6">จัดการของรางวัล (Weighted Probability)</h2>
            
            <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border">
                <h3 class="font-bold mb-4 text-sm uppercase text-gray-400">เพิ่ม/แก้ไข รางวัล</h3>
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <input id="p-name" placeholder="ชื่อรางวัล (เช่น บัตรทรู)" class="border p-2 rounded col-span-2">
                    <input id="p-color" type="color" class="h-10 w-full cursor-pointer">
                    <input id="p-chance" type="number" placeholder="โอกาส (%)" class="border p-2 rounded">
                </div>
                <textarea id="p-items" placeholder="สินค้าข้างใน (Nested Items) - ใส่บรรทัดละ 1 อัน&#10;เช่น:&#10;TRUE-001&#10;TRUE-002" class="w-full border p-2 rounded h-24 mb-4 font-mono text-sm"></textarea>
                <button onclick="addPrize()" class="bg-purple-600 text-white px-6 py-2 rounded font-bold hover:bg-purple-700">บันทึกรางวัล</button>
            </div>

            <div class="grid grid-cols-2 gap-4" id="prize-list"></div>
        </div>

        <div id="chat" class="section hidden h-full flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Live Chat</h2>
            <div class="flex flex-1 gap-4 overflow-hidden h-[500px]">
                <div id="user-list" class="w-1/3 bg-white border rounded overflow-y-auto"></div>
                <div class="w-2/3 bg-white border rounded flex flex-col">
                    <div id="msg-box" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-2">Select User</div>
                    <form onsubmit="sendAdminChat(event)" class="p-3 border-t flex gap-2">
                        <input id="admin-in" class="flex-1 border p-2 rounded" placeholder="Type...">
                        <button class="bg-purple-600 text-white px-4 rounded">Send</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="codes" class="section hidden">
            <h2 class="text-2xl font-bold mb-4">สร้างโค้ด</h2>
            <div class="flex gap-2 mb-4">
                <input id="new-code" class="border p-2 rounded flex-1" placeholder="CODE">
                <button onclick="createCode()" class="bg-green-600 text-white px-4 rounded">Create</button>
            </div>
            <div id="code-list" class="bg-white rounded border p-4"></div>
        </div>

    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // 1. PRIZES
        function addPrize() {
            const name = document.getElementById('p-name').value;
            const color = document.getElementById('p-color').value;
            const chance = Number(document.getElementById('p-chance').value);
            const itemsRaw = document.getElementById('p-items').value;
            const items = itemsRaw.split('\n').filter(x => x.trim() !== '');

            db.collection('wheel_prizes').add({
                name, color, chance, items, 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('p-name').value = '';
                document.getElementById('p-items').value = '';
                Swal.fire('Success', 'เพิ่มรางวัลแล้ว', 'success');
            });
        }

        db.collection('wheel_prizes').orderBy('createdAt').onSnapshot(snap => {
            const div = document.getElementById('prize-list');
            div.innerHTML = snap.docs.map(doc => {
                const d = doc.data();
                const stock = d.items ? d.items.length : 0;
                return `
                    <div class="bg-white p-4 rounded border shadow-sm relative">
                        <button onclick="db.collection('wheel_prizes').doc('${doc.id}').delete()" class="absolute top-2 right-2 text-red-400"><i class="fa-solid fa-trash"></i></button>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-4 h-4 rounded-full" style="background:${d.color}"></div>
                            <span class="font-bold">${d.name}</span>
                        </div>
                        <div class="text-sm text-gray-500">โอกาส: ${d.chance}% | สต็อกของ: ${stock} ชิ้น</div>
                    </div>
                `;
            }).join('');
        });

        // 2. CHAT
        let activeChat = null;
        rtdb.ref('chats').on('value', snap => {
            const div = document.getElementById('user-list');
            div.innerHTML = '';
            snap.forEach(c => {
                div.innerHTML += `<div onclick="loadChat('${c.key}')" class="p-3 border-b hover:bg-gray-100 cursor-pointer ${activeChat===c.key?'bg-purple-100':''}">User: ${c.key.substr(0,5)}</div>`;
            });
        });

        function loadChat(uid) {
            activeChat = uid;
            const div = document.getElementById('msg-box');
            div.innerHTML = '';
            rtdb.ref('chats/'+uid).limitToLast(20).on('child_added', s => {
                const m = s.val();
                const align = m.sender==='admin'?'text-right':'text-left';
                const color = m.sender==='admin'?'bg-purple-600 text-white':'bg-white border';
                div.innerHTML += `<div class="${align} mb-1"><span class="inline-block px-3 py-1 rounded ${color}">${m.text}</span></div>`;
                div.scrollTop = div.scrollHeight;
            });
        }

        function sendAdminChat(e) {
            e.preventDefault();
            const val = document.getElementById('admin-in').value;
            if(val && activeChat) {
                rtdb.ref('chats/'+activeChat).push({text:val, sender:'admin', timestamp: Date.now()});
                document.getElementById('admin-in').value = '';
            }
        }

        // 3. CODES
        function createCode() {
            const c = document.getElementById('new-code').value;
            if(c) db.collection('wheel_codes').add({code:c, status:'unused', createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        }
        db.collection('wheel_codes').orderBy('createdAt', 'desc').limit(20).onSnapshot(s => {
            document.getElementById('code-list').innerHTML = s.docs.map(d => `<div class="p-2 border-b flex justify-between"><span>${d.data().code}</span><span class="text-xs uppercase">${d.data().status}</span></div>`).join('');
        });

        function show(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        show('prizes');
    </script>
</body>
</html>
