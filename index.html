<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Tower | FoodRunner</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root {
            --sidebar-bg: #1e293b;
            --sidebar-active: #334155;
            --bg-body: #f1f5f9;
            --primary: #ff4757;
            --text-main: #334155;
            --success: #2ed573;
            --danger: #ff4757;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg-body); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text-main); }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: #94a3b8; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .brand { color: white; font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; transition: 0.2s; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: var(--sidebar-active); color: white; }
        .badge { background: var(--danger); color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 20px; margin-left: auto; }

        /* Main */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 1.8rem; font-weight: bold; }

        /* Cards */
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); border-left: 4px solid var(--primary); }
        .stat-val { font-size: 1.8rem; font-weight: bold; margin-top: 5px; }
        .stat-label { font-size: 0.9rem; color: #64748b; }

        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: #64748b; background: #f8fafc; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; color: white; font-size: 0.85rem; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--danger); }
        .btn-blue { background: #3742fa; }

        /* Bank Info Box */
        .bank-box { background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 5px 10px; border-radius: 6px; font-size: 0.85rem; display: inline-block; margin-top: 5px; }

        /* Chat Layout */
        .chat-wrapper { display: flex; height: 600px; background: white; border-radius: 16px; overflow: hidden; border: 1px solid #e2e8f0; }
        .chat-list { width: 300px; background: #f8fafc; border-right: 1px solid #e2e8f0; overflow-y: auto; }
        .chat-room { flex: 1; display: flex; flex-direction: column; background: white; }
        
        .chat-user-item { padding: 15px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
        .chat-user-item:hover { background: #eff6ff; }
        .chat-user-item.active { background: #dbeafe; border-left: 4px solid #3b82f6; }
        
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 10px; }
        .chat-input { padding: 15px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; background: white; }
        
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; max-width: 70%; line-height: 1.4; }
        .msg-me { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-other { background: #e2e8f0; color: #334155; align-self: flex-start; border-bottom-left-radius: 2px; }

        /* Login Modal */
        #login-modal { position: fixed; inset: 0; background: #1e293b; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 350px; text-align: center; }
        .inp-login { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; }

    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="margin-top:0;">Admin Access</h2>
            <input id="adm-email" class="inp-login" value="admin@food.com" readonly>
            <input id="adm-pass" type="password" class="inp-login" placeholder="Password">
            <button class="btn btn-blue" style="width:100%; padding:12px;" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="app" style="display:none; width:100%;">
        
        <aside class="sidebar">
            <div class="brand"><i class="fa-solid fa-tower-observation"></i> CONTROL</div>
            <div class="menu-item active" onclick="nav('dash', this)"><i class="fa-solid fa-chart-pie"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            <div class="menu-item" onclick="nav('tx', this)">
                <i class="fa-solid fa-money-bill-transfer"></i> ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° 
                <span id="badge-tx" class="badge" style="display:none;">0</span>
            </div>
            <div class="menu-item" onclick="nav('orders', this)"><i class="fa-solid fa-list-check"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Spy)</div>
            <div class="menu-item" onclick="nav('chat', this)">
                <i class="fa-solid fa-comments"></i> ‡πÅ‡∏ä‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 
                <span id="badge-chat" class="badge" style="display:none;">0</span>
            </div>
            <div class="menu-item" onclick="nav('users', this)"><i class="fa-solid fa-users"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div style="margin-top:auto;">
                <button class="btn btn-red" style="width:100%;" onclick="auth.signOut()"><i class="fa-solid fa-power-off"></i> Logout</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <div class="page-title" id="page-title">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
                <div style="color:#64748b;">Admin: admin@food.com</div>
            </div>

            <div id="p-dash">
                <div class="stats-grid">
                    <div class="stat-card" style="border-color:#3b82f6;">
                        <div class="stat-label">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="stat-val" id="st-users">0</div>
                    </div>
                    <div class="stat-card" style="border-color:#2ed573;">
                        <div class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        <div class="stat-val" id="st-money">0 ‡∏ø</div>
                    </div>
                    <div class="stat-card" style="border-color:#ffa502;">
                        <div class="stat-label">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏á‡∏¥‡∏ô</div>
                        <div class="stat-val" id="st-pending">0</div>
                    </div>
                    <div class="stat-card" style="border-color:#ff4757;">
                        <div class="stat-label">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                        <div class="stat-val" id="st-orders">0</div>
                    </div>
                </div>
            </div>

            <div id="p-tx" style="display:none;">
                <div class="card">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏ù‡∏≤‡∏Å/‡∏ñ‡∏≠‡∏ô)</h3>
                    <div id="tx-list">Loading...</div>
                </div>
            </div>

            <div id="p-orders" style="display:none;">
                <div class="card">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Realtime Spy)</h3>
                    <div id="orders-list">Loading...</div>
                </div>
            </div>

            <div id="p-chat" style="display:none;">
                <div class="chat-wrapper">
                    <div class="chat-list" id="chat-users-list">Loading...</div>
                    <div class="chat-room">
                        <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold;" id="chat-header">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó</div>
                        <div class="chat-messages" id="chat-box">
                            <div style="text-align:center; color:#ccc; margin-top:50px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</div>
                        </div>
                        <div class="chat-input" id="chat-inp-area" style="display:none;">
                            <input id="reply-inp" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
                            <button class="btn btn-blue" onclick="sendReply()">‡∏™‡πà‡∏á</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="p-users" style="display:none;">
                <div class="card">
                    <div style="display:flex; justify-content:space-between;">
                        <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
                        <input type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="padding:8px; border:1px solid #ccc; border-radius:6px;">
                    </div>
                    <div id="users-table" style="margin-top:15px;">Loading...</div>
                </div>
            </div>

        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allUsers = {};
        let currentChatUid = null;

        auth.onAuthStateChanged(u => {
            if(u && u.email === 'admin@food.com') {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                init();
            } else {
                if(u) Swal.fire('Error','‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô','error').then(()=>auth.signOut());
            }
        });

        function adminLogin() {
            const e = document.getElementById('adm-email').value;
            const p = document.getElementById('adm-pass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => Swal.fire('Error', err.message, 'error'));
        }

        function init() {
            loadUsers();
            loadTransactions();
            loadOrders();
            loadSupportChat();
        }

        // --- 1. USERS & STATS ---
        function loadUsers() {
            db.collection('users').onSnapshot(snap => {
                let html = '<table><thead><tr><th>User</th><th>Role</th><th>Bank Info</th><th>Balance</th><th>Action</th></tr></thead><tbody>';
                let totalMoney = 0;
                
                snap.forEach(doc => {
                    const u = doc.data();
                    allUsers[doc.id] = u; // Cache user data
                    totalMoney += u.balance;
                    
                    const bankInfo = u.bankName ? `<div class="bank-box">üè¶ ${u.bankName} - ${u.bankNo}</div>` : '-';

                    html += `<tr>
                        <td><b>${u.username}</b><br><small>${u.email}</small></td>
                        <td><span style="background:${u.role=='rider'?'#333':'#eee'}; color:${u.role=='rider'?'white':'black'}; padding:2px 6px; border-radius:4px; font-size:0.75rem;">${u.role.toUpperCase()}</span></td>
                        <td>${bankInfo}</td>
                        <td style="font-weight:bold; color:${u.balance>0?'green':'black'}">${u.balance.toLocaleString()} ‡∏ø</td>
                        <td>
                            <button class="btn btn-blue" style="padding:5px 10px;" onclick="editBal('${doc.id}', ${u.balance})">Edit</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                document.getElementById('users-table').innerHTML = html;
                document.getElementById('st-users').innerText = snap.size;
                document.getElementById('st-money').innerText = totalMoney.toLocaleString() + ' ‡∏ø';
            });
        }

        async function editBal(uid, old) {
            const {value:n} = await Swal.fire({title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô', input:'number', inputValue:old});
            if(n) await db.collection('users').doc(uid).update({balance: parseFloat(n)});
        }

        // --- 2. TRANSACTIONS ---
        function loadTransactions() {
            db.collection('transactions').where('status','==','pending').onSnapshot(snap => {
                const div = document.getElementById('tx-list');
                document.getElementById('st-pending').innerText = snap.size;
                
                const badge = document.getElementById('badge-tx');
                if(snap.size>0) { badge.innerText=snap.size; badge.style.display='inline-block'; } else badge.style.display='none';

                if(snap.empty) { div.innerHTML = '<p style="color:#ccc">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</p>'; return; }

                let html = '';
                snap.forEach(doc => {
                    const t = doc.data();
                    const u = allUsers[t.uid] || {username:'Unknown', bankName:'-', bankNo:'-'};
                    
                    const isDep = t.type==='deposit';
                    const color = isDep ? '#2ed573' : '#ff4757';
                    const icon = isDep ? '<i class="fa-solid fa-arrow-down"></i>' : '<i class="fa-solid fa-arrow-up"></i>';
                    
                    let detail = '';
                    if(!isDep) detail = `<div class="bank-box">‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ: ${u.bankName} - ${u.bankNo}</div>`;

                    html += `
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:15px 0;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div style="width:40px; height:40px; border-radius:50%; background:${isDep?'#d1fae5':'#ffe4e6'}; color:${color}; display:flex; justify-content:center; align-items:center;">${icon}</div>
                                <div>
                                    <div style="font-weight:bold;">${isDep?'‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô':'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'} <span style="color:${color}">${t.amount.toLocaleString()} ‡∏ø</span></div>
                                    <div style="font-size:0.85rem; color:#64748b;">User: ${u.username} (${u.email})</div>
                                    ${!isDep ? `<div style="font-size:0.8rem; color:red;">(‡∏´‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á: ${t.total} ‡∏ö‡∏≤‡∏ó)</div>` : ''}
                                    ${detail}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-green" onclick="approveTx('${doc.id}', '${t.uid}', ${t.amount}, '${t.type}', ${t.fee||0})">‚úî ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="btn btn-red" onclick="rejectTx('${doc.id}')">‚úò</button>
                            </div>
                        </div>
                    `;
                });
                div.innerHTML = html;
            });
        }

        async function approveTx(txId, uid, amount, type, fee) {
            const action = type==='withdraw' ? '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)' : '‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)';
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ ${action}?`)) return;

            try {
                await db.runTransaction(async t => {
                    const uRef = db.collection('users').doc(uid);
                    const txRef = db.collection('transactions').doc(txId);
                    const uDoc = await t.get(uRef);
                    let bal = uDoc.data().balance;

                    if(type === 'deposit') {
                        bal += amount;
                    } else {
                        // Withdraw: Check balance again
                        const deduct = amount + fee;
                        if(bal < deduct) throw "‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏ñ‡∏≠‡∏ô";
                        bal -= deduct;
                    }

                    t.update(uRef, {balance: bal});
                    t.update(txRef, {status: 'approved'});
                });
                Swal.fire('Success','‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
            } catch(e) { Swal.fire('Error',e.toString(),'error'); }
        }

        async function rejectTx(id) {
            if(confirm('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) await db.collection('transactions').doc(id).update({status:'rejected'});
        }

        // --- 3. ORDERS SPY ---
        function loadOrders() {
            db.collection('orders').orderBy('timestamp','desc').limit(20).onSnapshot(snap => {
                const div = document.getElementById('orders-list');
                document.getElementById('st-orders').innerText = snap.size;
                
                let html = '<table><thead><tr><th>Status</th><th>Menu</th><th>Price+Tip</th><th>Buyer</th><th>Rider</th><th>Payment</th></tr></thead><tbody>';
                snap.forEach(doc => {
                    const o = doc.data();
                    const buyer = allUsers[o.buyerId]?.username || 'Unknown';
                    const rider = o.riderId ? (allUsers[o.riderId]?.username || 'Unknown') : '-';
                    
                    html += `<tr>
                        <td><span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.75rem;">${o.status}</span></td>
                        <td>${o.menu}</td>
                        <td>${o.price + o.tip}</td>
                        <td>${buyer}</td>
                        <td>${rider}</td>
                        <td>${o.payment}</td>
                    </tr>`;
                });
                div.innerHTML = html + '</tbody></table>';
            });
        }

        // --- 4. CHAT SUPPORT (MESSENGER STYLE) ---
        function loadSupportChat() {
            // Listen to support list (Users who messaged)
            db.collection('support').where('status','==','pending').onSnapshot(snap => {
                const list = document.getElementById('chat-users-list');
                const badge = document.getElementById('badge-chat');
                
                if(snap.size>0) { badge.innerText=snap.size; badge.style.display='inline-block'; } 
                else badge.style.display='none';

                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `
                        <div class="chat-user-item" onclick="openChat('${d.uid}', '${d.email}')">
                            <div style="font-weight:bold;">${d.email}</div>
                            <div style="font-size:0.8rem; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${d.lastMsg}</div>
                            ${d.status==='pending' ? '<span style="color:red; font-size:1.5rem;">‚Ä¢</span>' : ''}
                        </div>
                    `;
                });
            });
        }

        function openChat(uid, email) {
            currentChatUid = uid;
            document.getElementById('chat-header').innerText = `Chat with: ${email}`;
            document.getElementById('chat-inp-area').style.display = 'flex';
            
            // Listen to messages
            db.collection('support_msgs').where('roomId','==',uid).orderBy('time').onSnapshot(snap => {
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    // If msg uid == currentChatUid (User sent it) -> Left
                    // If msg uid != currentChatUid (Admin sent it, because admin UID is different) -> Right
                    // *Trick*: Check if uid == selected user uid
                    const isUser = m.uid === uid; 
                    const cls = isUser ? 'msg-other' : 'msg-me';
                    
                    box.innerHTML += `<div class="msg ${cls}">${m.msg}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        async function sendReply() {
            const txt = document.getElementById('reply-inp').value;
            if(!txt || !currentChatUid) return;

            // 1. Add Msg
            await db.collection('support_msgs').add({
                roomId: currentChatUid,
                uid: 'admin', // Flag as admin
                msg: txt,
                time: new Date()
            });

            // 2. Update Status
            await db.collection('support').doc(currentChatUid).update({
                lastMsg: `Admin: ${txt}`,
                status: 'replied',
                timestamp: new Date()
            });

            document.getElementById('reply-inp').value = '';
        }

        // Utils
        function nav(page, el) {
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            
            ['dash','tx','orders','chat','users'].forEach(p => document.getElementById('p-'+p).style.display = 'none');
            document.getElementById('p-'+page).style.display = 'block';
            
            const titles = {'dash':'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î', 'tx':'‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', 'orders':'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå', 'chat':'Support Chat', 'users':'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'};
            document.getElementById('page-title').innerText = titles[page];
        }
    </script>
</body>
</html>
