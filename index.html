<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>FF Queue - Admin Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-900 text-white h-screen flex">

    <div class="w-96 bg-gray-800 p-6 border-r border-gray-700 flex flex-col">
        <h1 class="text-2xl font-bold mb-6 text-yellow-400">ADMIN CONTROL</h1>
        
        <div class="bg-gray-700 p-4 rounded-xl mb-6">
            <h3 class="font-bold mb-3"><i class="fa-solid fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
            <input id="p-name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°" class="w-full bg-gray-900 border border-gray-600 rounded p-2 mb-2 text-white">
            <input id="p-donate" type="number" placeholder="‡∏¢‡∏≠‡∏î‡πÇ‡∏î‡πÄ‡∏ô‡∏ó (‡∏ö‡∏≤‡∏ó)" class="w-full bg-gray-900 border border-gray-600 rounded p-2 mb-3 text-white">
            <button onclick="addPlayer()" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded font-bold">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>

        <div class="bg-gray-700 p-4 rounded-xl flex-1">
            <h3 class="font-bold mb-3 border-b border-gray-600 pb-2">üéÆ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á</h3>
            
            <div class="mb-4">
                <div class="text-xs text-gray-400">KING (‡πÅ‡∏ä‡∏°‡∏õ‡πå)</div>
                <div id="ctrl-king" class="text-xl font-bold text-red-400 mb-2">Wait...</div>
                
                <div class="text-xs text-gray-400">CHALLENGER (‡∏ú‡∏π‡πâ‡∏ó‡πâ‡∏≤‡∏ä‡∏¥‡∏á)</div>
                <div id="ctrl-challenger" class="text-xl font-bold text-blue-400">Wait...</div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="setWinner('king')" class="bg-red-600 hover:bg-red-500 py-4 rounded-lg font-bold">
                    üëë King Win
                </button>
                <button onclick="setWinner('challenger')" class="bg-blue-600 hover:bg-blue-500 py-4 rounded-lg font-bold">
                    ‚öîÔ∏è Challenger Win
                </button>
            </div>
            
            <button onclick="forceNextMatch()" class="w-full bg-gray-600 hover:bg-gray-500 py-2 rounded mt-4 text-sm">
                <i class="fa-solid fa-forward"></i> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á)
            </button>
        </div>
    </div>

    <div class="flex-1 p-6 overflow-y-auto">
        <h2 class="text-2xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô (Waiting List)</h2>
        <div class="overflow-hidden rounded-xl border border-gray-700">
            <table class="w-full text-left bg-gray-800">
                <thead class="bg-gray-900 text-gray-400">
                    <tr>
                        <th class="p-3">#</th>
                        <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th class="p-3">‡πÇ‡∏î‡πÄ‡∏ô‡∏ó</th>
                        <th class="p-3 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="admin-queue-list" class="divide-y divide-gray-700">
                    </tbody>
            </table>
        </div>
        
        <h2 class="text-2xl font-bold mt-8 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô (History)</h2>
        <div id="history-list" class="space-y-2 text-gray-400 text-sm"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Data Listeners ---
        
        // Load Queue
        db.collection('arena_queue').where('status', '==', 'waiting')
          .orderBy('donate', 'desc').orderBy('timestamp', 'asc')
          .onSnapshot(snap => {
              const tb = document.getElementById('admin-queue-list');
              tb.innerHTML = '';
              snap.docs.forEach((doc, idx) => {
                  const d = doc.data();
                  tb.innerHTML += `
                    <tr class="hover:bg-gray-700">
                        <td class="p-3 font-bold text-yellow-500">${idx+1}</td>
                        <td class="p-3 font-bold">${d.name}</td>
                        <td class="p-3 text-green-400">‡∏ø${d.donate}</td>
                        <td class="p-3 text-right">
                            <button onclick="addMoney('${doc.id}', ${d.donate})" class="bg-blue-600 px-2 py-1 rounded text-xs mr-2">+‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                            <button onclick="deletePlayer('${doc.id}')" class="bg-red-600 px-2 py-1 rounded text-xs"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                  `;
              });
          });

        // Load Current Match Info for Admin
        let kingDoc = null;
        let chalDoc = null;

        db.collection('arena_queue').where('status', '==', 'king').onSnapshot(s => {
            if(!s.empty) { kingDoc = s.docs[0]; document.getElementById('ctrl-king').innerText = kingDoc.data().name + ` (Wins: ${kingDoc.data().wins})`; }
            else { kingDoc = null; document.getElementById('ctrl-king').innerText = "-"; }
        });

        db.collection('arena_queue').where('status', '==', 'challenger').onSnapshot(s => {
            if(!s.empty) { chalDoc = s.docs[0]; document.getElementById('ctrl-challenger').innerText = chalDoc.data().name; }
            else { chalDoc = null; document.getElementById('ctrl-challenger').innerText = "-"; }
        });

        // Load History
        db.collection('arena_queue').where('status', '==', 'history').orderBy('timestamp', 'desc').limit(10).onSnapshot(s => {
            const div = document.getElementById('history-list');
            div.innerHTML = s.docs.map(d => `<div>‚Ä¢ ${d.data().name} (‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á)</div>`).join('');
        });

        // --- Functions ---

        function addPlayer() {
            const name = document.getElementById('p-name').value;
            const donate = Number(document.getElementById('p-donate').value);
            if(!name) return;

            db.collection('arena_queue').add({
                name: name,
                donate: donate,
                status: 'waiting',
                wins: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('p-name').value = '';
                document.getElementById('p-donate').value = '';
                
                // Auto fill slots if empty
                checkAndFillSlots();
            });
        }

        function addMoney(id, current) {
            Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡πÇ‡∏î‡πÄ‡∏ô‡∏ó',
                input: 'number',
                inputLabel: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ö‡∏≤‡∏ó)',
                inputValue: 0
            }).then(res => {
                if(res.isConfirmed && res.value > 0) {
                    const add = Number(res.value);
                    db.collection('arena_queue').doc(id).update({
                        donate: current + add
                    });
                }
            });
        }

        function deletePlayer(id) {
            if(confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?')) db.collection('arena_queue').doc(id).delete();
        }

        async function checkAndFillSlots() {
            // Logic: ‡∏ñ‡πâ‡∏≤ King ‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ Challenger ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á Waiting ‡∏°‡∏≤‡πÉ‡∏™‡πà
            if(!kingDoc) {
                const next = await getNextWaiting();
                if(next) await db.collection('arena_queue').doc(next.id).update({ status: 'king', wins: 0 });
            }
            // Re-check challenger after slight delay (firestore sync)
            setTimeout(async () => {
                if(!chalDoc) {
                    const next = await getNextWaiting();
                    if(next) await db.collection('arena_queue').doc(next.id).update({ status: 'challenger' });
                }
            }, 500);
        }

        async function getNextWaiting() {
            const snap = await db.collection('arena_queue').where('status', '==', 'waiting').orderBy('donate', 'desc').orderBy('timestamp', 'asc').limit(1).get();
            return snap.empty ? null : snap.docs[0];
        }

        async function setWinner(who) {
            if(!kingDoc || !chalDoc) return Swal.fire('Error', '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', 'error');

            const batch = db.batch();

            if(who === 'king') {
                // King ‡∏ä‡∏ô‡∏∞: King ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° (wins+1), Challenger ‡πÑ‡∏õ History
                batch.update(kingDoc.ref, { wins: (kingDoc.data().wins || 0) + 1 });
                batch.update(chalDoc.ref, { status: 'history' });
            } else {
                // Challenger ‡∏ä‡∏ô‡∏∞: King ‡πÑ‡∏õ History, Challenger ‡πÄ‡∏õ‡πá‡∏ô King (wins=1)
                batch.update(kingDoc.ref, { status: 'history' });
                batch.update(chalDoc.ref, { status: 'king', wins: 1 });
            }

            await batch.commit();
            
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Challenger
            const next = await getNextWaiting();
            if(next) {
                await db.collection('arena_queue').doc(next.id).update({ status: 'challenger' });
            } else {
                Swal.fire('Info', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß', 'info');
            }
        }

        function forceNextMatch() {
            checkAndFillSlots();
        }

    </script>
</body>
</html>
