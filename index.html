<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>FF Admin - Minimal Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; color: #334155; }
        .input-field {
            width: 100%; background: #fff; border: 1px solid #e2e8f0; border-radius: 0.75rem;
            padding: 0.75rem; transition: all 0.2s;
        }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn {
            width: 100%; padding: 0.75rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-80 bg-white border-r border-gray-200 flex flex-col z-20 overflow-y-auto">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-xl font-bold text-slate-800"><i class="fa-solid fa-gamepad text-blue-500 mr-2"></i>ADMIN CONTROL</h1>
        </div>

        <div class="p-6 space-y-6">
            
            <div class="space-y-3">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <input id="p-name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°" class="input-field">
                <input id="p-money" type="number" placeholder="‡∏¢‡∏≠‡∏î‡πÇ‡∏î‡πÄ‡∏ô‡∏ó (‡∏ö‡∏≤‡∏ó)" class="input-field">
                <button onclick="addPlayer()" class="btn bg-slate-900 text-white hover:bg-slate-700 shadow-lg">
                    <i class="fa-solid fa-plus mr-2"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏¥‡∏ß
                </button>
            </div>

            <hr class="border-gray-100">

            <div class="space-y-3">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á</h3>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-yellow-600">KING</span>
                        <span id="ad-king" class="font-bold text-slate-800">...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-blue-600">CHALLENGER</span>
                        <span id="ad-chal" class="font-bold text-slate-800">...</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setWinner('king')" class="btn bg-yellow-500 text-white hover:bg-yellow-600">
                        üëë ‡πÅ‡∏ä‡∏°‡∏õ‡πå‡∏ä‡∏ô‡∏∞
                    </button>
                    <button onclick="setWinner('chal')" class="btn bg-blue-600 text-white hover:bg-blue-700">
                        ‚öîÔ∏è ‡∏ú‡∏π‡πâ‡∏ó‡πâ‡∏≤‡∏ä‡∏¥‡∏á‡∏ä‡∏ô‡∏∞
                    </button>
                </div>
                <button onclick="forceNext()" class="btn bg-white border border-gray-200 text-slate-500 hover:bg-gray-50 text-sm">
                    <i class="fa-solid fa-forward mr-2"></i> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                </button>
            </div>

            <hr class="border-gray-100">

            <div class="space-y-3">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡∏¥‡πà‡∏á (Ticker)</h3>
                <textarea id="ann-input" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®..." class="input-field"></textarea>
                <div class="flex gap-2">
                    <button onclick="toggleAnn(true)" class="btn bg-green-500 text-white text-xs">‡πÄ‡∏õ‡∏¥‡∏î</button>
                    <button onclick="toggleAnn(false)" class="btn bg-red-500 text-white text-xs">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

        </div>
    </aside>

    <main class="flex-1 bg-slate-50 p-8 overflow-y-auto">
        
        <div class="flex justify-between items-end mb-6">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß (Waiting List)</h2>
                <p class="text-slate-400 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡πÇ‡∏î‡πÄ‡∏ô‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>
            <div class="bg-white px-4 py-2 rounded-xl shadow-sm border border-gray-100 font-bold text-slate-600">
                ‡∏£‡∏ß‡∏°: <span id="list-count" class="text-blue-600">0</span>
            </div>
        </div>

        <div class="card overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-100 text-slate-500 text-sm uppercase">
                    <tr>
                        <th class="p-4 w-16 text-center">#</th>
                        <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
                        <th class="p-4">‡πÇ‡∏î‡πÄ‡∏ô‡∏ó</th>
                        <th class="p-4 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="queue-table" class="divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>

        <div class="mt-8">
            <h3 class="font-bold text-slate-400 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (History)</h3>
            <div id="history-list" class="space-y-2"></div>
        </div>

    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Logic ---

        // 1. Add Player
        function addPlayer() {
            const name = document.getElementById('p-name').value;
            const money = Number(document.getElementById('p-money').value);

            if(!name) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', 'warning');

            db.collection('arena_queue').add({
                name: name,
                donate: money,
                status: 'waiting',
                wins: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('p-name').value = '';
                document.getElementById('p-money').value = '';
                checkLogic(); // Auto promote if empty
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
                Toast.fire({icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß'});
            });
        }

        // 2. Queue List
        db.collection('arena_queue').where('status', '==', 'waiting')
          .orderBy('donate', 'desc').orderBy('timestamp', 'asc')
          .onSnapshot(snap => {
              const tb = document.getElementById('queue-table');
              document.getElementById('list-count').innerText = snap.size;
              tb.innerHTML = '';
              
              if(snap.empty) {
                  tb.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠...</td></tr>';
                  return;
              }

              snap.docs.forEach((doc, i) => {
                  const d = doc.data();
                  tb.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-4 text-center font-bold text-slate-400">${i+1}</td>
                        <td class="p-4 font-bold text-slate-700">${d.name}</td>
                        <td class="p-4 font-bold text-green-600">‡∏ø${d.donate}</td>
                        <td class="p-4 text-right">
                            <button onclick="modMoney('${doc.id}', ${d.donate})" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded-lg text-xs font-bold mr-2">+‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                            <button onclick="delPlayer('${doc.id}')" class="bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1 rounded-lg text-xs font-bold">‡∏•‡∏ö</button>
                        </td>
                    </tr>
                  `;
              });
          });

        // 3. Match Logic
        let kDoc, cDoc;
        
        db.collection('arena_queue').where('status','==','king').onSnapshot(s => {
            kDoc = s.empty ? null : s.docs[0];
            document.getElementById('ad-king').innerText = kDoc ? `${kDoc.data().name} (${kDoc.data().wins} Win)` : '-';
        });
        db.collection('arena_queue').where('status','==','challenger').onSnapshot(s => {
            cDoc = s.empty ? null : s.docs[0];
            document.getElementById('ad-chal').innerText = cDoc ? cDoc.data().name : '-';
        });
        
        // History
        db.collection('arena_queue').where('status','==','history').orderBy('timestamp','desc').limit(5).onSnapshot(s => {
            document.getElementById('history-list').innerHTML = s.docs.map(d => 
                `<div class="bg-white p-3 rounded-lg border border-slate-200 text-sm text-slate-500 flex justify-between"><span>${d.data().name}</span> <span class="text-xs bg-slate-100 px-2 rounded">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</span></div>`
            ).join('');
        });

        // 4. Actions
        function modMoney(id, oldVal) {
            Swal.fire({ title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡πÇ‡∏î‡πÄ‡∏ô‡∏ó', input: 'number' }).then(res => {
                if(res.value) db.collection('arena_queue').doc(id).update({ donate: oldVal + Number(res.value) });
            });
        }
        function delPlayer(id) {
            if(confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ?')) db.collection('arena_queue').doc(id).delete();
        }

        async function checkLogic() {
            if(!kDoc) {
                const next = await getNext();
                if(next) await db.collection('arena_queue').doc(next.id).update({status: 'king', wins: 0});
            }
            setTimeout(async () => {
                if(!cDoc) {
                    const next = await getNext();
                    if(next) await db.collection('arena_queue').doc(next.id).update({status: 'challenger'});
                }
            }, 500);
        }

        async function getNext() {
            const s = await db.collection('arena_queue').where('status','==','waiting').orderBy('donate','desc').orderBy('timestamp','asc').limit(1).get();
            return s.empty ? null : s.docs[0];
        }

        async function setWinner(who) {
            if(!kDoc || !cDoc) return Swal.fire('Error', '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', 'error');
            const batch = db.batch();
            
            if(who === 'king') {
                batch.update(kDoc.ref, { wins: (kDoc.data().wins||0)+1 });
                batch.update(cDoc.ref, { status: 'history' });
            } else {
                batch.update(kDoc.ref, { status: 'history' });
                batch.update(cDoc.ref, { status: 'king', wins: 1 });
            }
            await batch.commit();
            
            const next = await getNext();
            if(next) await db.collection('arena_queue').doc(next.id).update({status:'challenger'});
        }

        function forceNext() { checkLogic(); }

        // Announcement
        function toggleAnn(state) {
            const txt = document.getElementById('ann-input').value;
            db.collection('announcements').doc('config').set({ text: txt, active: state });
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', state ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

    </script>
</body>
</html>
