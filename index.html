<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command | ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background: #f3f4f6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .req-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .type-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; }
        .type-reset { background: #fee2e2; color: #ef4444; } /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™ */
        .type-issue { background: #e0f2fe; color: #0284c7; } /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
        
        .action-area { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; }
        .btn-reply { background: #4f46e5; }
        .btn-reset { background: #10b981; }
    </style>
</head>
<body>

    <div class="container">
        <h2>üì• ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° & ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <div id="request-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23",
            measurementId: "G-GR38B5JHZZ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(user => {
            if(!user) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); window.location.href='index.html'; }
            else loadRequests();
        });

        function loadRequests() {
            db.collection('reports').orderBy('timestamp', 'desc').onSnapshot(snap => {
                const div = document.getElementById('request-list');
                div.innerHTML = '';
                if(snap.empty) { div.innerHTML = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà'; return; }

                snap.forEach(doc => {
                    const r = doc.data();
                    const isReset = r.type === 'reset_password';
                    
                    let actionHtml = '';
                    if(isReset && r.status !== 'done') {
                        actionHtml = `<button class="btn-reset" onclick="performReset('${doc.id}', '${r.email}')">üìß ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>`;
                    } else if (!isReset && r.status !== 'done') {
                        actionHtml = `
                            <input type="text" id="reply-${doc.id}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö...">
                            <button class="btn-reply" onclick="sendReply('${doc.id}')">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</button>
                        `;
                    } else {
                        actionHtml = '<span style="color:green;">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</span>';
                    }

                    div.innerHTML += `
                        <div class="card">
                            <div class="req-header">
                                <span class="type-badge ${isReset ? 'type-reset' : 'type-issue'}">${isReset ? '‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : '‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤'}</span>
                                <small>${r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleString() : ''}</small>
                            </div>
                            <div><b>User:</b> ${r.email}</div>
                            <div style="margin-top:5px;"><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${r.message}</div>
                            <div class="action-area">
                                ${actionHtml}
                            </div>
                        </div>
                    `;
                });
            });
        }

        // 1. ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° -> ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏õ‡∏´‡∏≤ User
        async function performReset(docId, email) {
            if(confirm('‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏ó‡∏µ‡πà ' + email + ' ?')) {
                try {
                    await auth.sendPasswordResetEmail(email);
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß
                    await db.collection('reports').doc(docId).update({ status: 'done', adminReply: '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß' });
                    Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            }
        }

        // 2. ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        async function sendReply(docId) {
            const txt = document.getElementById('reply-'+docId).value;
            if(!txt) return;
            await db.collection('reports').doc(docId).update({
                status: 'done',
                adminReply: txt
            });
            Swal.fire('‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
        }
    </script>
</body>
</html>
