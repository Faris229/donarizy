<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Manager (Fixed)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root { --bg: #f3f4f6; --dark: #111827; --primary: #ff4757; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Login */
        #login-modal { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 350px; text-align: center; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; }

        /* Sidebar */
        .sidebar { width: 250px; background: var(--dark); color: #9ca3af; display: flex; flex-direction: column; padding: 20px; }
        .menu-item { padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; border-radius: 8px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .badge { background: #ff4757; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: auto; }

        /* Main */
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; background: #f9fafb; padding: 10px; color: #6b7280; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        
        .role-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .role-user { background: #e0f2fe; color: #0284c7; }
        .role-rider { background: #dcfce7; color: #16a34a; }

        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 0.8rem; }
        .btn-blue { background: #3b82f6; }
        .btn-green { background: #22c55e; }
        .btn-red { background: #ef4444; }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="margin-top:0;">Admin Login</h2>
            <input id="adm-email" value="farisxuma1@gmail.com" readonly style="background:#eee;">
            <input id="adm-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn btn-blue" style="width:100%; padding:12px; font-size:1rem;" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="app" style="display:none; width:100%;">
        <aside class="sidebar">
            <h2 style="color:white; margin-bottom:30px;">FoodControl</h2>
            <div class="menu-item active" onclick="nav('dash', this)"><i class="fa-solid fa-chart-pie"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
            <div class="menu-item" onclick="nav('tx', this)">
                <i class="fa-solid fa-money-bill-transfer"></i> ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° 
                <span id="badge-tx" class="badge" style="display:none">0</span>
            </div>
            <div class="menu-item" onclick="nav('customers', this)"><i class="fa-solid fa-users"></i> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="menu-item" onclick="nav('riders', this)"><i class="fa-solid fa-motorcycle"></i> ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
            <div style="margin-top:auto;"><button class="btn btn-red" style="width:100%;" onclick="auth.signOut()">Logout</button></div>
        </aside>

        <main class="main">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 id="page-title" style="margin:0;">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <span style="color:#888;">Admin: farisxuma1@gmail.com</span>
            </div>

            <div id="p-dash">
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:20px;">
                    <div class="card" style="border-left:4px solid #3b82f6;">
                        <div>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div style="font-size:2rem; font-weight:bold;" id="st-users">0</div>
                    </div>
                    <div class="card" style="border-left:4px solid #22c55e;">
                        <div>‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        <div style="font-size:2rem; font-weight:bold;" id="st-money">0</div>
                    </div>
                    <div class="card" style="border-left:4px solid #ef4444;">
                        <div>‡∏£‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                        <div style="font-size:2rem; font-weight:bold;" id="st-pending">0</div>
                    </div>
                </div>
            </div>

            <div id="p-tx" style="display:none;">
                <div class="card">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏ù‡∏≤‡∏Å/‡∏ñ‡∏≠‡∏ô)</h3>
                    <div id="tx-table">Loading...</div>
                </div>
            </div>

            <div id="p-customers" style="display:none;">
                <div class="card">
                    <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                    <div id="customer-table">Loading...</div>
                </div>
            </div>

            <div id="p-riders" style="display:none;">
                <div class="card">
                    <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
                    <div id="rider-table">Loading...</div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allUsersCache = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°

        // Check Auth
        auth.onAuthStateChanged(u => {
            if(u && u.email === 'farisxuma1@gmail.com') {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                initData();
            } else {
                if(u) Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô','error').then(()=>auth.signOut());
                document.getElementById('login-modal').style.display = 'flex';
            }
        });

        function doLogin() {
            const e = document.getElementById('adm-email').value;
            const p = document.getElementById('adm-pass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', err.message, 'error'));
        }

        function initData() {
            loadAllUsers();
            loadTransactions();
        }

        // --- 1. LOAD USERS (Combined Logic) ---
        function loadAllUsers() {
            db.collection('users').onSnapshot(snap => {
                let totalUsers = 0;
                let totalMoney = 0;
                
                // HTML Tables
                let custHtml = '<table width="100%"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
                let riderHtml = '<table width="100%"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</th><th>‡∏£‡∏ñ/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
                
                let hasCust = false;
                let hasRider = false;

                snap.forEach(doc => {
                    const u = doc.data();
                    allUsers[doc.id] = u; // Cache
                    totalUsers++;
                    totalMoney += (u.balance || 0);

                    const bankInfo = u.bankName ? `<small>${u.bankName}<br>${u.bankNo}</small>` : '-';
                    const editBtn = `<button class="btn btn-blue" onclick="editBalance('${doc.id}', ${u.balance})">‡πÅ‡∏Å‡πâ‡πÄ‡∏á‡∏¥‡∏ô</button>`;

                    // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Role
                    if(u.role === 'rider') {
                        hasRider = true;
                        riderHtml += `<tr>
                            <td>${u.username}<br><small>${u.email}</small></td>
                            <td>${u.vehicle || '-'}<br>${u.plate || '-'}</td>
                            <td>${bankInfo}</td>
                            <td style="color:green; font-weight:bold;">${(u.balance||0).toLocaleString()}</td>
                            <td>${editBtn}</td>
                        </tr>`;
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Role ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Customer
                        hasCust = true;
                        custHtml += `<tr>
                            <td>${u.username}<br><small>${u.email}</small></td>
                            <td>${u.phone || '-'}</td>
                            <td>${bankInfo}</td>
                            <td style="font-weight:bold;">${(u.balance||0).toLocaleString()}</td>
                            <td>${editBtn}</td>
                        </tr>`;
                    }
                });

                custHtml += '</tbody></table>';
                riderHtml += '</tbody></table>';

                // Render
                document.getElementById('customer-table').innerHTML = hasCust ? custHtml : '<p style="text-align:center; padding:20px; color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>';
                document.getElementById('rider-table').innerHTML = hasRider ? riderHtml : '<p style="text-align:center; padding:20px; color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</p>';
                
                // Stats
                document.getElementById('st-users').innerText = totalUsers;
                document.getElementById('st-money').innerText = totalMoney.toLocaleString() + ' ‡∏ø';
            });
        }

        async function editBalance(uid, oldVal) {
            const {value:n} = await Swal.fire({title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô', input:'number', inputValue:oldVal});
            if(n) {
                await db.collection('users').doc(uid).update({balance: parseFloat(n)});
                Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','','success');
            }
        }

        // --- 2. LOAD TRANSACTIONS ---
        function loadTransactions() {
            db.collection('transactions').where('status','==','pending').onSnapshot(snap => {
                const div = document.getElementById('tx-table');
                document.getElementById('st-pending').innerText = snap.size;
                
                const badge = document.getElementById('badge-tx');
                if(snap.size > 0) { badge.style.display='inline-block'; badge.innerText=snap.size; } 
                else badge.style.display='none';

                if(snap.empty) {
                    div.innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</div>';
                    return;
                }

                let html = '<table width="100%"><thead><tr><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô?</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
                
                snap.forEach(doc => {
                    const t = doc.data();
                    const u = allUsers[t.uid] || {username:'Unknown', bankName:'-', bankNo:'-'};
                    const isDep = t.type === 'deposit';
                    
                    // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡∏≠‡∏ô)
                    let bankDetail = '-';
                    if(!isDep) {
                        bankDetail = `<span style="color:#0284c7; background:#e0f2fe; padding:2px 5px; border-radius:4px;">üè¶ ${u.bankName} ${u.bankNo}</span>`;
                    }

                    html += `<tr>
                        <td><span class="role-badge ${isDep?'role-rider':'role-user'}" style="background:${isDep?'#dcfce7':'#fee2e2'}; color:${isDep?'green':'red'}">${isDep?'‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô':'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'}</span></td>
                        <td>${u.username}</td>
                        <td style="font-weight:bold;">${t.amount.toLocaleString()}</td>
                        <td>${bankDetail}</td>
                        <td>
                            <button class="btn btn-green" onclick="processTx('${doc.id}', '${t.uid}', ${t.amount}, '${t.type}', ${t.fee||0})">‚úî</button>
                            <button class="btn btn-red" onclick="rejectTx('${doc.id}')">‚úò</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                div.innerHTML = html;
            });
        }

        async function processTx(txId, uid, amount, type, fee) {
            const action = type==='deposit' ? '‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)' : '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)';
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ ${action}?`)) return;

            try {
                await db.runTransaction(async t => {
                    const uRef = db.collection('users').doc(uid);
                    const txRef = db.collection('transactions').doc(txId);
                    const uDoc = await t.get(uRef);
                    
                    if(!uDoc.exists) throw "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                    
                    let bal = uDoc.data().balance || 0;

                    if(type === 'deposit') {
                        bal += amount;
                    } else {
                        const deduct = amount + fee;
                        if(bal < deduct) throw "‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å";
                        bal -= deduct;
                    }

                    t.update(uRef, {balance: bal});
                    t.update(txRef, {status: 'approved'});
                });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success');
            } catch(e) { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', e.toString(), 'error'); }
        }

        async function rejectTx(id) {
            if(confirm('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) await db.collection('transactions').doc(id).update({status:'rejected'});
        }

        function nav(page, el) {
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            ['dash','tx','customers','riders'].forEach(p => document.getElementById('p-'+p).style.display='none');
            document.getElementById('p-'+page).style.display='block';
            
            const titles = {'dash':'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î','tx':'‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô','customers':'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤','riders':'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå'};
            document.getElementById('page-title').innerText = titles[page];
        }
    </script>
</body>
</html>
