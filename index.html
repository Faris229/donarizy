<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel | ติดการบ้าน</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        /* === THEME เดียวกับหน้าหลัก === */
        :root {
            --primary: #4338ca;
            --primary-light: #6366f1;
            --primary-grad: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --bg-body: #f1f5f9;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-bg: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 16px;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; min-height: 100vh; overflow-x: hidden; }

        /* Buttons & Inputs */
        .btn { padding: 10px 20px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .btn-primary { background: var(--primary-grad); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-ghost:hover { background: #e2e8f0; color: var(--text-main); }

        /* Navbar */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; padding: 0 25px;
            z-index: 1000; box-shadow: 0 1px 0 rgba(0,0,0,0.05);
        }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        /* Layout */
        .container { margin-top: var(--nav-height); padding: 30px 20px; max-width: 1000px; margin-left: auto; margin-right: auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 1.8rem; font-weight: 800; margin: 0; color: var(--text-main); }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--primary-grad); }
        .stat-num { font-size: 2.5rem; font-weight: 800; margin: 10px 0; color: var(--primary); }
        .stat-label { font-size: 0.9rem; color: var(--text-muted); }

        /* User List Card */
        .user-card { 
            background: white; border-radius: var(--radius); box-shadow: var(--shadow); 
            margin-bottom: 15px; padding: 20px; display: flex; align-items: center; justify-content: space-between;
            transition: 0.2s; border: 1px solid #f1f5f9;
        }
        .user-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); }
        
        .user-info { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-light); }
        .user-text h4 { margin: 0; font-size: 1.1rem; }
        .user-text p { margin: 2px 0 0; font-size: 0.85rem; color: var(--text-muted); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 600px; padding: 30px; border-radius: 24px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow); }

        /* Task Item inside Modal */
        .task-item { 
            padding: 15px; border-bottom: 1px dashed #e2e8f0; display: flex; justify-content: space-between; align-items: center; 
        }
        .task-item:last-child { border-bottom: none; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }

        #loading { text-align: center; padding: 50px; color: var(--text-muted); font-size: 1.2rem; }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand">
            <i class="fa-solid fa-shield-halved"></i> Admin Panel
        </div>
        <button class="btn btn-ghost" onclick="window.location.href='index.html'">
            <i class="fa-solid fa-house"></i> กลับหน้าหลัก
        </button>
    </nav>

    <div class="container">
        
        <div class="page-header">
            <h1 class="page-title">แดชบอร์ดผู้ดูแล</h1>
            <button class="btn btn-primary" onclick="loadData()">
                <i class="fa-solid fa-rotate-right"></i> รีเฟรช
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <i class="fa-solid fa-users" style="font-size: 2rem; color: #cbd5e1;"></i>
                <div class="stat-num" id="count-users">0</div>
                <div class="stat-label">ผู้ใช้งานทั้งหมด</div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-layer-group" style="font-size: 2rem; color: #cbd5e1;"></i>
                <div class="stat-num" id="count-tasks">0</div>
                <div class="stat-label">งานทั้งหมดในระบบ</div>
            </div>
        </div>

        <h3 style="margin-bottom: 20px; color: var(--text-main);">รายชื่อผู้ใช้</h3>
        <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</div>
        <div id="user-list"></div>

    </div>

    <div class="modal-overlay" id="task-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">งานของ: <span id="modal-username" style="color:var(--primary);"></span></h3>
                <button class="btn btn-ghost" onclick="document.getElementById('task-modal').classList.remove('active')">
                    <i class="fa-solid fa-xmark" style="font-size:1.5rem;"></i>
                </button>
            </div>
            <div id="user-tasks-list">กำลังโหลด...</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // --- CONFIG (ต้องเหมือนหน้าหลัก) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23",
            measurementId: "G-GR38B5JHZZ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- AUTH CHECK ---
        auth.onAuthStateChanged(user => {
            if (!user) {
                Swal.fire({
                    icon: 'error', title: 'เข้าไม่ได้', text: 'กรุณาล็อกอินที่หน้าหลักก่อน',
                    confirmButtonText: 'ไปหน้าหลัก'
                }).then(() => window.location.href = 'index.html');
            } else {
                loadData();
            }
        });

        // --- LOAD DATA ---
        async function loadData() {
            const list = document.getElementById('user-list');
            const loading = document.getElementById('loading');
            
            list.innerHTML = '';
            loading.style.display = 'block';

            try {
                // 1. ดึงผู้ใช้ทั้งหมด
                const usersSnap = await db.collection('users').get();
                let totalTasks = 0;
                
                document.getElementById('count-users').innerText = usersSnap.size;

                if(usersSnap.empty) {
                    loading.style.display = 'none';
                    list.innerHTML = '<div style="text-align:center; color:#999;">ไม่มีผู้ใช้งาน</div>';
                    return;
                }

                // 2. วนลูปสร้าง Card
                for (const doc of usersSnap.docs) {
                    const u = doc.data();
                    const uid = doc.id;
                    
                    // นับงานของแต่ละคน (แบบ Realtime เล็กน้อย)
                    const tasksSnap = await db.collection('homeworks').doc(uid).collection('items').get();
                    const taskCount = tasksSnap.size;
                    totalTasks += taskCount;

                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.innerHTML = `
                        <div class="user-info">
                            <img src="${u.photoURL || 'https://ui-avatars.com/api/?name=User'}" class="avatar">
                            <div class="user-text">
                                <h4>${u.username || 'ไม่ระบุชื่อ'}</h4>
                                <p>${u.email}</p>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.9rem; font-weight:bold; color:var(--primary); margin-bottom:5px;">${taskCount} งาน</div>
                            <button class="btn btn-primary" style="padding:6px 15px; font-size:0.85rem;" onclick="viewTasks('${uid}', '${u.username}')">
                                <i class="fa-solid fa-eye"></i> ดูงาน
                            </button>
                        </div>
                    `;
                    list.appendChild(card);
                }

                document.getElementById('count-tasks').innerText = totalTasks;
                loading.style.display = 'none';

            } catch (error) {
                loading.innerHTML = `<span style="color:red;">โหลดไม่ได้: ${error.message}<br>กรุณาเช็ค Rules ใน Firebase Console</span>`;
            }
        }

        // --- VIEW TASKS ---
        async function viewTasks(uid, name) {
            document.getElementById('modal-username').innerText = name || 'User';
            document.getElementById('task-modal').classList.add('active');
            const container = document.getElementById('user-tasks-list');
            container.innerHTML = '<div style="text-align:center;"><i class="fa-solid fa-spinner fa-spin"></i> กำลังโหลด...</div>';

            const snap = await db.collection('homeworks').doc(uid).collection('items').get();
            
            if(snap.empty) {
                container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ไม่มีงานค้าง</div>';
                return;
            }

            container.innerHTML = '';
            snap.forEach(doc => {
                const t = doc.data();
                const div = document.createElement('div');
                div.className = 'task-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600;">${t.subject}</div>
                        <div style="font-size:0.85rem; color:#64748b;">${t.content || '-'}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="badge ${t.isCompleted ? 'bg-green' : 'bg-red'}">
                            ${t.isCompleted ? 'เสร็จ' : 'ค้าง'}
                        </span>
                        <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteTask('${uid}', '${doc.id}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- DELETE TASK ---
        function deleteTask(uid, taskId) {
            Swal.fire({
                title: 'ลบงานนี้?',
                text: "ในฐานะแอดมิน คุณกำลังจะลบงานของผู้ใช้นี้",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ลบเลย'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await db.collection('homeworks').doc(uid).collection('items').doc(taskId).delete();
                    
                    // Refresh Modal List
                    const name = document.getElementById('modal-username').innerText;
                    viewTasks(uid, name);
                    
                    Swal.fire({icon:'success', title:'ลบเรียบร้อย', timer:1000, showConfirmButton:false});
                }
            });
        }

    </script>
</body>
</html>
