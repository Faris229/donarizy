<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro Max | ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sidebar-width: 260px;
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg-sidebar: #0f172a;
            --bg-main: #f1f5f9;
            --text-nav: #94a3b8;
            --white: #ffffff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body { font-family: 'Prompt', sans-serif; background: var(--bg-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: var(--bg-sidebar); z-index: 5000; display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--white); padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .login-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 15px; font-family: inherit; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); color: var(--text-nav); display: flex; flex-direction: column; padding: 20px; transition: 0.3s; flex-shrink: 0; }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--white); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: var(--white); }
        .nav-item i { width: 20px; text-align: center; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 1.8rem; font-weight: 700; color: #1e293b; margin: 0; }
        
        /* Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin: 5px 0; color: var(--primary); }
        .stat-label { color: #64748b; font-size: 0.9rem; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .user-row:hover { background: #f8fafc; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #e2e8f0; }

        /* Inputs & Buttons */
        .search-box { width: 100%; max-width: 300px; padding: 10px 15px; border-radius: 50px; border: 1px solid #cbd5e1; outline: none; transition: 0.2s; }
        .search-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); }
        .btn-warning { background: var(--warning); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn:hover { filter: brightness(110%); transform: translateY(-1px); }

        /* Support Ticket */
        .ticket-item { border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 15px; background: white; }
        .ticket-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .status-pending { background: #fee2e2; color: #ef4444; }
        .status-done { background: #dcfce7; color: #166534; }
        .reply-area { margin-top: 15px; display: flex; gap: 10px; }
        .reply-input { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #475569; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:var(--bg-sidebar); margin-bottom:20px;">Admin Pro Max</h2>
            <input type="email" id="admin-email" class="login-input" placeholder="Email ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô">
            <input type="password" id="admin-pass" class="login-input" placeholder="Password">
            <button class="btn btn-primary" style="width:100%; padding:12px; justify-content:center;" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="app-panel" style="display:none; width:100%; height:100%;">
        
        <aside class="sidebar">
            <div class="brand"><i class="fa-solid fa-rocket"></i> AdminPro</div>
            <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            <div class="nav-item" onclick="switchTab('users', this)"><i class="fa-solid fa-users-gear"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="nav-item" onclick="switchTab('support', this)">
                <i class="fa-solid fa-headset"></i> ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 
                <span id="badge-support" style="background:#ef4444; color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px; display:none; margin-left:auto;">New</span>
            </div>
            <div class="nav-item" onclick="switchTab('broadcast', this)"><i class="fa-solid fa-bullhorn"></i> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß</div>
            <div style="margin-top:auto;">
                <div class="nav-item" style="color:#ef4444;" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
            </div>
        </aside>

        <main class="main-content">
            
            <div id="tab-dashboard" class="tab-view">
                <div class="header"><h1 class="page-title">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h1></div>
                <div class="stats-grid">
                    <div class="card">
                        <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="stat-value" id="stat-users">0</div>
                    </div>
                    <div class="card">
                        <div class="stat-label">‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        <div class="stat-value" id="stat-tasks" style="color:var(--success);">0</div>
                    </div>
                    <div class="card">
                        <div class="stat-label">‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
                        <div class="stat-value" id="stat-tickets" style="color:var(--warning);">0</div>
                    </div>
                </div>
                <div class="card" style="height: 300px;">
                    <canvas id="dashboardChart"></canvas>
                </div>
            </div>

            <div id="tab-users" class="tab-view" style="display:none;">
                <div class="header">
                    <h1 class="page-title">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
                    <input type="text" class="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•..." onkeyup="searchUser(this)">
                </div>
                <div class="card table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                                <th style="text-align:right;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="user-table"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-support" class="tab-view" style="display:none;">
                <div class="header"><h1 class="page-title">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ / ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</h1></div>
                <div id="ticket-container" style="max-width: 800px;"></div>
            </div>

            <div id="tab-broadcast" class="tab-view" style="display:none;">
                <div class="header"><h1 class="page-title">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ (Broadcast)</h1></div>
                <div class="card" style="max-width: 600px;">
                    <div class="form-group">
                        <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)</label>
                        <textarea id="broadcast-msg" class="form-input" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö, ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="broadcast-status" class="form-input">
                            <option value="true">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÅ‡∏™‡∏î‡∏á)</option>
                            <option value="false">‡∏õ‡∏¥‡∏î (‡∏ã‡πà‡∏≠‡∏ô)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="saveBroadcast()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                </div>
            </div>

        </main>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
            <input type="hidden" id="edit-uid">
            <div class="form-group">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (Username)</label>
                <input type="text" id="edit-name" class="form-input">
            </div>
            <div class="form-group">
                <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (URL)</label>
                <input type="text" id="edit-photo" class="form-input">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn" style="background:#cbd5e1; color:#334155;" onclick="document.getElementById('edit-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-primary" onclick="saveEditUser()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="task-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                <button onclick="document.getElementById('task-modal').classList.remove('active')" style="border:none; background:none; font-size:1.5rem;">&times;</button>
            </div>
            <div id="user-tasks-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23",
            measurementId: "G-GR38B5JHZZ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-panel').style.display = 'flex';
                initData();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        async function adminLogin() {
            try {
                await auth.signInWithEmailAndPassword(
                    document.getElementById('admin-email').value,
                    document.getElementById('admin-pass').value
                );
            } catch(e) { Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', 'error'); }
        }

        function logout() {
            Swal.fire({title:'‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', showCancelButton:true, confirmButtonColor:'#ef4444'}).then(r => { if(r.isConfirmed) auth.signOut(); });
        }

        function initData() {
            loadUsers();
            loadTickets();
            loadBroadcast();
        }

        // --- 1. DASHBOARD & USERS ---
        let allUsers = []; // Store for searching

        async function loadUsers() {
            const tbody = document.getElementById('user-table');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
            
            db.collection('users').orderBy('createdAt', 'desc').onSnapshot(async snap => {
                allUsers = [];
                let totalTasks = 0;
                tbody.innerHTML = '';
                
                document.getElementById('stat-users').innerText = snap.size;

                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }

                for (const doc of snap.docs) {
                    const u = doc.data();
                    const uid = doc.id;
                    // Get task count (Note: in real app, maybe store count in user doc to avoid N+1 reads)
                    const tSnap = await db.collection('homeworks').doc(uid).collection('items').get();
                    const tCount = tSnap.size;
                    totalTasks += tCount;

                    allUsers.push({ uid, ...u, tCount, element: null }); // Store for search

                    const tr = document.createElement('tr');
                    tr.className = 'user-row';
                    tr.innerHTML = `
                        <td>
                            <div class="user-info">
                                <img src="${u.photoURL || 'https://ui-avatars.com/api/?name=User'}" class="avatar">
                                <b>${u.username || 'No Name'}</b>
                            </div>
                        </td>
                        <td>${u.email}</td>
                        <td>${u.createdAt ? new Date(u.createdAt.seconds*1000).toLocaleDateString('th-TH') : '-'}</td>
                        <td style="text-align:right;">
                            <button class="btn btn-primary" title="‡∏î‡∏π‡∏á‡∏≤‡∏ô" onclick="viewTasks('${uid}', '${u.username}')"><i class="fa-solid fa-eye"></i> ${tCount}</button>
                            <button class="btn btn-warning" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" onclick="openEditUser('${uid}', '${u.username}', '${u.photoURL||''}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn btn-success" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" onclick="resetPass('${u.email}')"><i class="fa-solid fa-key"></i></button>
                            <button class="btn btn-danger" title="‡∏•‡∏ö" onclick="deleteUser('${uid}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    // Update stored object reference
                    allUsers[allUsers.length-1].element = tr;
                }
                
                document.getElementById('stat-tasks').innerText = totalTasks;
                updateChart(snap.size, totalTasks);
            });
        }

        function searchUser(input) {
            const term = input.value.toLowerCase();
            allUsers.forEach(user => {
                const text = (user.username + user.email).toLowerCase();
                if(text.includes(term)) user.element.style.display = '';
                else user.element.style.display = 'none';
            });
        }

        // --- 2. SUPPORT TICKETS ---
        function loadTickets() {
            db.collection('reports').orderBy('timestamp', 'desc').onSnapshot(snap => {
                const con = document.getElementById('ticket-container');
                con.innerHTML = '';
                let pending = 0;

                snap.forEach(doc => {
                    const t = doc.data();
                    if(t.status === 'pending') pending++;
                    
                    const isReset = t.type === 'reset_password';
                    let badge = t.status === 'pending' ? '<span class="status-badge status-pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>' : '<span class="status-badge status-done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>';
                    
                    // Reset Password Action
                    let actionHtml = '';
                    if(isReset && t.status === 'pending') {
                        actionHtml = `<button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="approveReset('${doc.id}', '${t.email}')">üìß ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>`;
                    } else if (t.status === 'pending') {
                        actionHtml = `
                            <div class="reply-area">
                                <input id="reply-${doc.id}" class="reply-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö...">
                                <button class="btn btn-primary" onclick="replyTicket('${doc.id}')">‡∏™‡πà‡∏á</button>
                            </div>`;
                    } else {
                        actionHtml = `<div style="margin-top:10px; color:#166534; font-size:0.9rem;"><b>‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß:</b> ${t.adminReply}</div>`;
                    }

                    con.innerHTML += `
                        <div class="ticket-item" style="${isReset ? 'border-left:4px solid #f59e0b;' : 'border-left:4px solid #4f46e5;'}">
                            <div class="ticket-header">
                                <div>
                                    <b>${isReset ? 'üîë ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : t.subject}</b>
                                    <div style="font-size:0.8rem; color:#64748b;">‡∏à‡∏≤‡∏Å: ${t.email}</div>
                                </div>
                                ${badge}
                            </div>
                            <p style="color:#334155; font-size:0.9rem;">${t.message}</p>
                            ${actionHtml}
                        </div>
                    `;
                });

                document.getElementById('stat-tickets').innerText = pending;
                document.getElementById('badge-support').style.display = pending > 0 ? 'inline-block' : 'none';
            });
        }

        // --- 3. ACTIONS ---
        
        // Reset Password
        async function resetPass(email) {
            if(confirm(`‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ ${email}?`)) {
                try { await auth.sendPasswordResetEmail(email); Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success'); }
                catch(e) { Swal.fire('Error', e.message, 'error'); }
            }
        }
        async function approveReset(did, email) {
            try {
                await auth.sendPasswordResetEmail(email);
                await db.collection('reports').doc(did).update({status:'done', adminReply:'‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß'});
                Swal.fire('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }

        // Edit User
        function openEditUser(uid, name, photo) {
            document.getElementById('edit-uid').value = uid;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-photo').value = photo;
            document.getElementById('edit-modal').classList.add('active');
        }
        async function saveEditUser() {
            const uid = document.getElementById('edit-uid').value;
            const n = document.getElementById('edit-name').value;
            const p = document.getElementById('edit-photo').value;
            await db.collection('users').doc(uid).update({username:n, photoURL:p});
            document.getElementById('edit-modal').classList.remove('active');
            Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
        }

        // Delete User
        async function deleteUser(uid) {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ? (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)')) {
                await db.collection('users').doc(uid).delete();
                // Note: Subcollections need backend delete usually, but we assume client delete here
                Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
            }
        }

        // Reply Ticket
        async function replyTicket(did) {
            const txt = document.getElementById('reply-'+did).value;
            if(!txt) return;
            await db.collection('reports').doc(did).update({status:'done', adminReply:txt});
            Swal.fire('‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
        }

        // View Tasks
        async function viewTasks(uid, name) {
            document.getElementById('task-modal').classList.add('active');
            const div = document.getElementById('user-tasks-list');
            div.innerHTML = 'Loading...';
            const snap = await db.collection('homeworks').doc(uid).collection('items').get();
            div.innerHTML = '';
            if(snap.empty) div.innerHTML = '<p style="text-align:center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</p>';
            snap.forEach(d => {
                const t = d.data();
                div.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <span><b>${t.subject}</b>: ${t.content}</span>
                    <span style="color:red; cursor:pointer;" onclick="delTask('${uid}','${d.id}')"><i class="fa-solid fa-trash"></i></span>
                </div>`;
            });
        }
        async function delTask(uid, tid) {
            if(confirm('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) {
                await db.collection('homeworks').doc(uid).collection('items').doc(tid).delete();
                alert('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)');
            }
        }

        // Broadcast
        function loadBroadcast() {
            db.collection('site_config').doc('main').get().then(doc => {
                if(doc.exists) {
                    document.getElementById('broadcast-msg').value = doc.data().announcement || '';
                    document.getElementById('broadcast-status').value = doc.data().showAnnouncement ? 'true' : 'false';
                }
            });
        }
        async function saveBroadcast() {
            const msg = document.getElementById('broadcast-msg').value;
            const status = document.getElementById('broadcast-status').value === 'true';
            await db.collection('site_config').doc('main').set({announcement:msg, showAnnouncement:status}, {merge:true});
            Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
        }

        // Chart (Using Chart.js)
        let chart;
        function updateChart(users, tasks) {
            const ctx = document.getElementById('dashboardChart');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô'],
                    datasets: [{
                        data: [users, tasks],
                        backgroundColor: ['#4f46e5', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        // Tabs
        function switchTab(tab, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.tab-view').forEach(t => t.style.display = 'none');
            document.getElementById('tab-'+tab).style.display = 'block';
        }
    </script>
</body>
</html>
