<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FF Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; padding-bottom: 80px; } /* Padding for bottom bar */
        
        .input-box { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; background: white; font-size: 16px; } /* Font 16px prevents zoom on iOS */
        .btn-action { padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.97); }

        /* Mobile Tabs */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
        
        .nav-btn.active { color: #2563eb; }
        .nav-btn.active i { transform: translateY(-2px); }
    </style>
</head>
<body class="md:flex md:h-screen md:pb-0 md:overflow-hidden">

    <aside class="hidden md:flex w-80 bg-white border-r border-gray-200 flex-col z-20">
        <div class="p-6 border-b border-gray-100 font-bold text-xl text-slate-800">Admin Control</div>
        <nav class="p-4 space-y-2">
            <button onclick="switchTab('tab-control')" class="w-full text-left p-3 rounded hover:bg-slate-50 font-bold text-slate-600">üéÆ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á</button>
            <button onclick="switchTab('tab-add')" class="w-full text-left p-3 rounded hover:bg-slate-50 font-bold text-slate-600">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
            <button onclick="switchTab('tab-list')" class="w-full text-left p-3 rounded hover:bg-slate-50 font-bold text-slate-600">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß</button>
            <button onclick="switchTab('tab-setting')" class="w-full text-left p-3 rounded hover:bg-slate-50 font-bold text-slate-600">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-8 md:overflow-y-auto w-full max-w-3xl mx-auto">
        
        <div class="md:hidden flex items-center justify-between mb-6">
            <h1 class="text-xl font-bold text-slate-800">FF Arena Admin</h1>
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>

        <div id="tab-control" class="tab-content active">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-6">
                <div class="text-xs font-bold text-slate-400 uppercase mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                <div class="flex justify-between items-center mb-2 p-3 bg-yellow-50 rounded-xl border border-yellow-100">
                    <span class="text-xs font-bold text-yellow-700">KING</span>
                    <span id="mon-king" class="font-bold text-slate-800">...</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl border border-blue-100">
                    <span class="text-xs font-bold text-blue-700">CHAL</span>
                    <span id="mon-chal" class="font-bold text-slate-800">...</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <button onclick="setWinner('king')" class="btn-action bg-yellow-500 text-white shadow-lg shadow-yellow-200">üëë King Win</button>
                <button onclick="setWinner('chal')" class="btn-action bg-blue-600 text-white shadow-lg shadow-blue-200">‚öîÔ∏è Chal Win</button>
            </div>
            <button onclick="forceNext()" class="btn-action bg-white border border-slate-200 text-slate-500 text-sm">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Force Next)</button>
        </div>

        <div id="tab-add" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="font-bold text-lg mb-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏¥‡∏ß</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°</label>
                        <input id="inp-name" type="text" class="input-box" placeholder="Ex. Somsak_007">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">‡∏¢‡∏≠‡∏î‡πÇ‡∏î‡πÄ‡∏ô‡∏ó</label>
                        <input id="inp-donate" type="number" class="input-box" placeholder="0">
                    </div>
                    <button onclick="addPlayer()" class="btn-action bg-slate-900 text-white shadow-xl mt-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                </div>
            </div>
        </div>

        <div id="tab-list" class="tab-content">
            <h2 class="font-bold text-lg mb-4 flex justify-between">
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠ (Queue) <span class="text-blue-600 text-sm bg-blue-50 px-2 rounded" id="list-count">0</span>
            </h2>
            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                        <tr><th class="p-4">Name</th><th class="p-4 text-right">Donate</th><th class="p-4 text-center">Act</th></tr>
                    </thead>
                    <tbody id="queue-table" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-setting" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                <h2 class="font-bold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <div class="grid grid-cols-2 gap-3">
                    <input id="conf-king" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏ö King" class="input-box text-sm">
                    <input id="conf-chal" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏ö Chal" class="input-box text-sm">
                </div>
                <textarea id="conf-ann" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®..." class="input-box text-sm"></textarea>
                <div class="flex gap-2">
                    <button onclick="saveConfig(true)" class="btn-action bg-green-500 text-white text-xs">Update & Show</button>
                    <button onclick="saveConfig(false)" class="btn-action bg-red-100 text-red-500 text-xs">Hide</button>
                </div>
                <hr>
                <button onclick="resetSystem()" class="text-xs text-red-400 underline w-full text-center">Reset System (‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡πä‡∏Å)</button>
            </div>
        </div>

    </main>

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 h-16 flex justify-around items-center z-50 pb-safe">
        <button onclick="switchTab('tab-control')" class="nav-btn active flex flex-col items-center text-slate-400 text-xs gap-1 w-full">
            <i class="fa-solid fa-gamepad text-xl"></i> ‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ç‡πà‡∏á
        </button>
        <button onclick="switchTab('tab-add')" class="nav-btn flex flex-col items-center text-slate-400 text-xs gap-1 w-full">
            <i class="fa-solid fa-circle-plus text-xl"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô
        </button>
        <button onclick="switchTab('tab-list')" class="nav-btn flex flex-col items-center text-slate-400 text-xs gap-1 w-full">
            <i class="fa-solid fa-list-ol text-xl"></i> ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠
        </button>
        <button onclick="switchTab('tab-setting')" class="nav-btn flex flex-col items-center text-slate-400 text-xs gap-1 w-full">
            <i class="fa-solid fa-gear text-xl"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        </button>
    </nav>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const sysRef = db.collection('arena_system').doc('main_state');
        const qRef = sysRef.collection('queue');

        // Logic
        sysRef.onSnapshot(doc => {
            if(doc.exists) {
                const d = doc.data();
                document.getElementById('mon-king').innerText = d.kingName || '-';
                document.getElementById('mon-chal').innerText = d.chalName || '-';
                if(document.activeElement.id !== 'conf-king') document.getElementById('conf-king').value = d.kingTitle || 'KING';
                if(document.activeElement.id !== 'conf-chal') document.getElementById('conf-chal').value = d.chalTitle || 'CHALLENGER';
                if(document.activeElement.id !== 'conf-ann') document.getElementById('conf-ann').value = d.announcementText || '';
            } else resetSystem(true);
        });

        qRef.orderBy('donate', 'desc').orderBy('timestamp', 'asc').onSnapshot(snap => {
            document.getElementById('list-count').innerText = snap.size;
            const tb = document.getElementById('queue-table');
            tb.innerHTML = '';
            snap.forEach((doc, i) => {
                const d = doc.data();
                tb.innerHTML += `
                    <tr class="border-b border-slate-50 last:border-0">
                        <td class="p-4 font-bold text-slate-700">
                            <div class="text-[10px] text-slate-400">#${i+1}</div>${d.name}
                        </td>
                        <td class="p-4 text-right font-bold text-green-500">‡∏ø${d.donate}</td>
                        <td class="p-4 text-center">
                            <button onclick="delQ('${doc.id}')" class="text-red-400 p-2"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            if(snap.empty) tb.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-slate-400">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</td></tr>';
        });

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Update Nav Icons
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(b => b.classList.remove('active'));
            // Simple logic to highlight clicked based on onclick attr match (simplified)
            event.currentTarget.classList.add('active');
        }

        // Actions
        function addPlayer() {
            const n = document.getElementById('inp-name').value;
            const m = Number(document.getElementById('inp-donate').value);
            if(!n) return Swal.fire('Error', '‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢', 'error');
            qRef.add({name:n, donate:m, timestamp: firebase.firestore.FieldValue.serverTimestamp()})
                .then(() => {
                    document.getElementById('inp-name').value = '';
                    document.getElementById('inp-donate').value = '';
                    autoFill();
                    Swal.fire({icon:'success', title:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß', toast:true, position:'top-end', showConfirmButton:false, timer:1500});
                });
        }

        function delQ(id) { if(confirm('‡∏•‡∏ö?')) qRef.doc(id).delete(); }

        async function autoFill() {
            const doc = await sysRef.get();
            const d = doc.data();
            if(!d.kingName || d.kingName==='‡∏ß‡πà‡∏≤‡∏á') {
                const n = await nextQ();
                if(n) { await sysRef.update({kingName:n.name, kingWins:0}); await qRef.doc(n.id).delete(); }
            }
            setTimeout(async () => {
                const d2 = (await sysRef.get()).data();
                if(!d2.chalName || d2.chalName==='‡∏ß‡πà‡∏≤‡∏á') {
                    const n = await nextQ();
                    if(n) { await sysRef.update({chalName:n.name, chalDonate:n.donate}); await qRef.doc(n.id).delete(); }
                }
            }, 500);
        }

        async function nextQ() {
            const s = await qRef.orderBy('donate','desc').orderBy('timestamp','asc').limit(1).get();
            return s.empty ? null : {id:s.docs[0].id, ...s.docs[0].data()};
        }

        async function setWinner(who) {
            const d = (await sysRef.get()).data();
            if(!d.kingName || !d.chalName || d.kingName==='‡∏ß‡πà‡∏≤‡∏á' || d.chalName==='‡∏ß‡πà‡∏≤‡∏á') return Swal.fire('Wait', '‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', 'warning');
            
            const n = await nextQ();
            const u = {};
            if(who==='king') {
                u.kingWins = (d.kingWins||0)+1;
                u.chalName = n ? n.name : '‡∏ß‡πà‡∏≤‡∏á';
                u.chalDonate = n ? n.donate : 0;
            } else {
                u.kingName = d.chalName;
                u.kingWins = 1;
                u.chalName = n ? n.name : '‡∏ß‡πà‡∏≤‡∏á';
                u.chalDonate = n ? n.donate : 0;
            }
            if(n) await qRef.doc(n.id).delete();
            await sysRef.update(u);
        }

        function forceNext() { autoFill(); }

        function saveConfig(active) {
            sysRef.update({
                kingTitle: document.getElementById('conf-king').value,
                chalTitle: document.getElementById('conf-chal').value,
                announcementText: document.getElementById('conf-ann').value,
                announcementActive: active
            }).then(() => Swal.fire({icon:'success', title:'Updated', toast:true, position:'top', showConfirmButton:false, timer:1000}));
        }

        function resetSystem(silent) {
            const def = { kingName:'‡∏ß‡πà‡∏≤‡∏á', kingWins:0, kingTitle:'KING', chalName:'‡∏ß‡πà‡∏≤‡∏á', chalDonate:0, chalTitle:'CHALLENGER', announcementText:'Welcome', announcementActive:false };
            sysRef.set(def, {merge:true}).then(()=> !silent && Swal.fire('Reset Done'));
        }
    </script>
</body>
</html>
