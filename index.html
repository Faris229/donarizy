<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>MathMate - Teacher Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="flex h-screen bg-slate-900 text-slate-300 font-sans overflow-hidden">

    <aside class="w-64 bg-slate-950 border-r border-slate-800 flex flex-col">
        <div class="h-16 flex items-center px-6 border-b border-slate-800 font-bold text-lg text-blue-400">Teacher Panel</div>
        <nav class="flex-1 p-2">
            <div id="student-list" class="space-y-1">
                </div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col bg-slate-900">
        <header class="h-16 border-b border-slate-800 flex items-center px-6 justify-between bg-slate-900">
            <span id="chat-title" class="font-bold text-white">Select Student</span>
            <button onclick="firebase.auth().signOut()" class="text-red-400 hover:text-red-300 text-sm">Logout</button>
        </header>
        
        <div class="flex-1 flex gap-4 p-4 overflow-hidden">
            <div class="flex-1 flex flex-col bg-slate-950 rounded-xl border border-slate-800 overflow-hidden">
                <div id="msg-box" class="flex-1 p-4 overflow-y-auto space-y-2"></div>
                <form onsubmit="Send(event)" class="p-3 bg-slate-900 border-t border-slate-800 flex gap-2">
                    <input id="reply-in" class="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-2 text-white" placeholder="Reply..." disabled>
                    <button id="reply-btn" class="bg-blue-600 text-white px-4 rounded disabled:opacity-50" disabled>Send</button>
                </form>
            </div>
            
            <div class="w-72 bg-slate-950 rounded-xl border border-slate-800 p-4 overflow-y-auto hidden md:block">
                <h3 class="font-bold text-sm text-slate-400 mb-3 uppercase">Recent Calculations</h3>
                <div id="calc-history" class="space-y-2 text-sm">Select a student...</div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBt4Hsmdf6BITdtYvysSMnkmfwFX_4Pm8s",
            authDomain: "hubfu-c4296.firebaseapp.com",
            projectId: "hubfu-c4296",
            storageBucket: "hubfu-c4296.firebasestorage.app",
            messagingSenderId: "864674622740",
            appId: "1:864674622740:web:3131798892e0e63e12a601"
        };
        firebase.initializeApp(firebaseConfig);
        const rtdb = firebase.database();
        const db = firebase.firestore();
        const ADMIN_EMAIL = 'farisxuma1@gmail.com';

        let activeUid = null;
        let chatListener = null;

        // Login Check
        firebase.auth().onAuthStateChanged(u => {
            if(!u || u.email !== ADMIN_EMAIL) {
                const e = prompt('Admin Email:');
                const p = prompt('Password:');
                firebase.auth().signInWithEmailAndPassword(e, p).catch(alert);
            } else {
                LoadStudents();
            }
        });

        function LoadStudents() {
            rtdb.ref('chats').on('value', snap => {
                const div = document.getElementById('student-list');
                div.innerHTML = '';
                snap.forEach(c => {
                    const uid = c.key;
                    div.innerHTML += `
                        <button onclick="LoadChat('${uid}')" class="w-full text-left px-4 py-3 rounded hover:bg-slate-800 flex items-center gap-3 ${activeUid===uid?'bg-blue-900/30 text-blue-300':''}">
                            <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs"><i class="fa-solid fa-user"></i></div>
                            <span class="truncate text-sm font-mono">ID: ${uid.substr(0,5)}</span>
                        </button>
                    `;
                });
            });
        }

        function LoadChat(uid) {
            if(chatListener) chatListener.off();
            activeUid = uid;
            
            document.getElementById('chat-title').innerText = `Chatting with: ${uid}`;
            document.getElementById('reply-in').disabled = false;
            document.getElementById('reply-btn').disabled = false;
            
            const box = document.getElementById('msg-box');
            box.innerHTML = '';

            chatListener = rtdb.ref('chats/'+uid);
            chatListener.limitToLast(50).on('child_added', s => {
                const m = s.val();
                const me = m.sender === 'admin';
                box.innerHTML += `
                    <div class="flex ${me?'justify-end':'justify-start'}">
                        <div class="px-3 py-2 rounded-xl text-sm max-w-[80%] ${me?'bg-blue-600 text-white':'bg-slate-800 border border-slate-700'}">${m.text}</div>
                    </div>
                `;
                box.scrollTop = 9999;
            });

            // Load Calc History
            db.collection('math_history').where('uid','==',uid).orderBy('ts','desc').limit(10).onSnapshot(snap => {
                const h = document.getElementById('calc-history');
                if(snap.empty) { h.innerHTML='No data'; return;}
                h.innerHTML = snap.docs.map(d => `
                    <div class="p-2 bg-slate-900 border border-slate-800 rounded">
                        <div class="text-slate-400 font-mono text-xs">${d.data().expr}</div>
                        <div class="text-green-400 font-bold">= ${d.data().res}</div>
                    </div>
                `).join('');
            });
        }

        function Send(e) {
            e.preventDefault();
            const inp = document.getElementById('reply-in');
            if(inp.value && activeUid) {
                rtdb.ref('chats/'+activeUid).push({text:inp.value, sender:'admin', ts:Date.now()});
                inp.value = '';
            }
        }
    </script>
</body>
</html>
