<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro | ระบบจัดการหลังบ้าน</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root {
            --sidebar-bg: #1e293b;
            --sidebar-text: #94a3b8;
            --main-bg: #f3f4f6;
            --card-bg: #ffffff;
            --primary: #4f46e5;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body { font-family: 'Prompt', sans-serif; background: var(--main-bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding: 20px; transition: 0.3s; }
        .brand { font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--primary); }
        
        .menu-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; color: var(--sidebar-text); display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .menu-item i { width: 20px; text-align: center; }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .admin-profile { display: flex; align-items: center; gap: 10px; background: white; padding: 8px 15px; border-radius: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .stat-val { font-size: 2.5rem; font-weight: 700; margin: 10px 0; color: var(--primary); }
        .stat-label { color: #64748b; font-size: 0.9rem; }

        /* Table */
        .table-container { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 15px; color: #64748b; font-weight: 600; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .user-cell { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #e2e8f0; }
        
        /* Action Buttons */
        .action-btn { padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; margin-right: 5px; transition: 0.2s; color: white; }
        .btn-edit { background: var(--warning); }
        .btn-reset { background: var(--primary); }
        .btn-del { background: var(--danger); }
        .btn-view { background: #0ea5e9; }
        .action-btn:hover { opacity: 0.8; transform: translateY(-1px); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 16px; }
        input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: #0f172a; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; }
        .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <i class="fa-solid fa-user-shield" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
            <h2 style="margin-bottom: 20px;">Admin Login</h2>
            <input type="email" id="admin-email" placeholder="อีเมลแอดมิน">
            <input type="password" id="admin-pass" placeholder="รหัสผ่าน">
            <button class="btn-login" onclick="adminLogin()">เข้าสู่ระบบ</button>
        </div>
    </div>

    <div id="admin-panel" style="display: none; width: 100%; height: 100%;">
        
        <aside class="sidebar">
            <div class="brand">
                <i class="fa-solid fa-shapes"></i> Admin Panel
            </div>
            <div class="menu-item active">
                <i class="fa-solid fa-users-gear"></i> จัดการผู้ใช้
            </div>
            <div class="menu-item" onclick="alert('ฟีเจอร์รายงาน (เร็วๆนี้)')">
                <i class="fa-solid fa-chart-line"></i> รายงานสถิติ
            </div>
            <div class="menu-item" onclick="alert('ฟีเจอร์ตั้งค่า (เร็วๆนี้)')">
                <i class="fa-solid fa-gear"></i> ตั้งค่าระบบ
            </div>
            <div style="margin-top: auto;">
                <div class="menu-item" onclick="logout()" style="color: #ef4444;">
                    <i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ
                </div>
            </div>
        </aside>

        <main class="main">
            <div class="header">
                <h2>จัดการผู้ใช้งาน</h2>
                <div class="admin-profile">
                    <i class="fa-solid fa-circle-user" style="font-size: 1.5rem; color: var(--primary);"></i>
                    <span id="admin-display-email">Admin</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="card">
                    <i class="fa-solid fa-users" style="font-size: 1.5rem; color: #94a3b8;"></i>
                    <div class="stat-val" id="total-users">0</div>
                    <div class="stat-label">ผู้ใช้งานทั้งหมด</div>
                </div>
                <div class="card">
                    <i class="fa-solid fa-layer-group" style="font-size: 1.5rem; color: #94a3b8;"></i>
                    <div class="stat-val" id="total-tasks">0</div>
                    <div class="stat-label">งานทั้งหมดในระบบ</div>
                </div>
            </div>

            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>รายชื่อสมาชิก</h3>
                    <button onclick="loadData()" style="padding:8px 15px; border-radius:8px; border:none; background:#e2e8f0; cursor:pointer;"><i class="fa-solid fa-rotate"></i> รีเฟรช</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ผู้ใช้</th>
                            <th>อีเมล</th>
                            <th>วันที่สมัคร</th>
                            <th>จำนวนงาน</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="user-table">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-box">
            <h3>แก้ไขข้อมูลผู้ใช้</h3>
            <input type="hidden" id="edit-uid">
            <label>ชื่อผู้ใช้ (Username)</label>
            <input type="text" id="edit-username">
            <label>รูปโปรไฟล์ (URL)</label>
            <input type="text" id="edit-photo">
            <div style="text-align: right;">
                <button class="action-btn" style="background:#94a3b8; color:white; padding:10px 20px;" onclick="document.getElementById('edit-modal').classList.remove('active')">ยกเลิก</button>
                <button class="action-btn" style="background:var(--primary); color:white; padding:10px 20px;" onclick="saveEditUser()">บันทึก</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // --- CONFIG (ต้องเหมือนเว็บหลัก) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23",
            measurementId: "G-GR38B5JHZZ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'flex';
                document.getElementById('admin-display-email').innerText = user.email;
                loadData();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        async function adminLogin() {
            const e = document.getElementById('admin-email').value;
            const p = document.getElementById('admin-pass').value;
            try {
                await auth.signInWithEmailAndPassword(e, p);
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                Toast.fire({ icon: 'success', title: 'ยินดีต้อนรับแอดมิน' });
            } catch(err) { Swal.fire('เข้าไม่ได้', 'อีเมลหรือรหัสผ่านผิด', 'error'); }
        }

        function logout() { auth.signOut(); }

        // --- LOAD DATA ---
        async function loadData() {
            const tbody = document.getElementById('user-table');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>';
            
            try {
                const usersSnap = await db.collection('users').orderBy('createdAt', 'desc').get();
                
                document.getElementById('total-users').innerText = usersSnap.size;
                let totalTasks = 0;
                
                if (usersSnap.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ไม่พบข้อมูลผู้ใช้</td></tr>';
                    return;
                }

                tbody.innerHTML = ''; // Clear loading

                for (const doc of usersSnap.docs) {
                    const u = doc.data();
                    const uid = doc.id;
                    
                    // Count Tasks
                    const taskSnap = await db.collection('homeworks').doc(uid).collection('items').get();
                    const taskCount = taskSnap.size;
                    totalTasks += taskCount;

                    // Date Formatter
                    let dateStr = '-';
                    if(u.createdAt) dateStr = new Date(u.createdAt.seconds * 1000).toLocaleDateString('th-TH');

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="user-cell">
                                <img src="${u.photoURL || 'https://ui-avatars.com/api/?name=User'}" class="avatar">
                                <b>${u.username || 'No Name'}</b>
                            </div>
                        </td>
                        <td>${u.email}</td>
                        <td>${dateStr}</td>
                        <td><span style="background:#e0f2fe; color:#0284c7; padding:2px 8px; border-radius:4px;">${taskCount} งาน</span></td>
                        <td>
                            <button class="action-btn btn-view" title="ดูงาน" onclick="alert('ดูงานของ ${u.username} จำนวน ${taskCount} งาน')"><i class="fa-solid fa-eye"></i></button>
                            <button class="action-btn btn-edit" title="แก้ไข" onclick="editUser('${uid}', '${u.username}', '${u.photoURL}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="action-btn btn-reset" title="รีเซ็ตรหัส" onclick="resetUserPass('${u.email}')"><i class="fa-solid fa-key"></i></button>
                            <button class="action-btn btn-del" title="ลบ" onclick="deleteUser('${uid}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                document.getElementById('total-tasks').innerText = totalTasks;

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">โหลดไม่ได้: กรุณาเช็ค Rules</td></tr>`;
            }
        }

        // --- ACTIONS ---
        
        // 1. Edit User
        function editUser(uid, name, photo) {
            document.getElementById('edit-uid').value = uid;
            document.getElementById('edit-username').value = name;
            document.getElementById('edit-photo').value = photo;
            document.getElementById('edit-modal').classList.add('active');
        }

        async function saveEditUser() {
            const uid = document.getElementById('edit-uid').value;
            const name = document.getElementById('edit-username').value;
            const photo = document.getElementById('edit-photo').value;
            
            try {
                await db.collection('users').doc(uid).update({ username: name, photoURL: photo });
                document.getElementById('edit-modal').classList.remove('active');
                Swal.fire('เรียบร้อย', 'แก้ไขข้อมูลสำเร็จ', 'success');
                loadData(); // Refresh table
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }

        // 2. Reset Password
        async function resetUserPass(email) {
            Swal.fire({
                title: 'รีเซ็ตรหัสผ่าน?',
                text: `ระบบจะส่งอีเมลเปลี่ยนรหัสไปที่ ${email}`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ส่งเลย'
            }).then(async (res) => {
                if(res.isConfirmed) {
                    try {
                        await auth.sendPasswordResetEmail(email);
                        Swal.fire('ส่งแล้ว', 'แจ้งผู้ใช้ให้เช็คอีเมลได้เลย', 'success');
                    } catch(e) { Swal.fire('ไม่สำเร็จ', e.message, 'error'); }
                }
            });
        }

        // 3. Delete User (Database Only)
        async function deleteUser(uid) {
            Swal.fire({
                title: 'ลบผู้ใช้?',
                text: "ข้อมูลผู้ใช้และงานทั้งหมดจะหายไป (แต่บัญชี Login ยังอยู่)",
                icon: 'error',
                showCancelButton: true,
                confirmButtonText: 'ลบข้อมูล',
                confirmButtonColor: '#ef4444'
            }).then(async (res) => {
                if(res.isConfirmed) {
                    try {
                        // 1. ลบเอกสาร User
                        await db.collection('users').doc(uid).delete();
                        // 2. ลบงาน (แบบง่ายๆ อาจจะไม่หมดถ้ามีเยอะมาก แต่เบื้องต้นพอไหว)
                        const tasks = await db.collection('homeworks').doc(uid).collection('items').get();
                        tasks.forEach(doc => doc.ref.delete());
                        
                        Swal.fire('ลบแล้ว', 'ข้อมูลถูกลบออกจากฐานข้อมูล', 'success');
                        loadData();
                    } catch(e) { Swal.fire('Error', e.message, 'error'); }
                }
            });
        }

    </script>
</body>
</html>
