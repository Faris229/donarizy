<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Monitor (Fixed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background: #f0f2f5; display: flex; margin: 0; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: #1e293b; color: white; padding: 20px; display: flex; flex-direction: column; }
        .menu-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: #334155; }
        
        /* Main */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Login */
        #login-screen { position: fixed; inset: 0; background: #1e293b; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; background: #f8f9fa; padding: 10px; border-bottom: 2px solid #eee; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .btn { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; color: white; }
        .btn-green { background: #2ed573; } .btn-red { background: #ff4757; } .btn-blue { background: #3742fa; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Admin Login</h2>
            <p style="color:red; font-size:0.8rem;">*‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏• farisxuma1@gmail.com ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
            <input id="adm-email" value="farisxuma1@gmail.com" readonly style="background:#eee;">
            <input id="adm-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn btn-blue" style="width:100%; padding:10px;" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="app" style="display:none; width:100%;">
        <div class="sidebar">
            <h3>FoodRunner Admin</h3>
            <div class="menu-item active" onclick="show('users')"><i class="fa-solid fa-users"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ & ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
            <div class="menu-item" onclick="show('tx')"><i class="fa-solid fa-money-bill"></i> ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
            <div style="margin-top:auto;">
                <button class="btn btn-red" style="width:100%;" onclick="auth.signOut()">Logout</button>
            </div>
        </div>

        <div class="main">
            <div id="page-users">
                <div class="card">
                    <h3>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ & ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå)</h3>
                    <div id="user-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... (‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Config ‡∏ú‡∏¥‡∏î)</div>
                </div>
            </div>

            <div id="page-tx" style="display:none;">
                <div class="card">
                    <h3>üí∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ù‡∏≤‡∏Å / ‡∏ñ‡∏≠‡∏ô)</h3>
                    <div id="tx-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        const firebaseConfig = {
            apiKey: "AIzaSy..... (‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)",
            authDomain: "......firebaseapp.com",
            projectId: "......",
            storageBucket: "......appspot.com",
            messagingSenderId: "......",
            appId: "......"
        };
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            alert("Error: ‡πÉ‡∏™‡πà Firebase Config ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!");
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        let allUsers = {}; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        auth.onAuthStateChanged(user => {
            if(user && user.email === 'farisxuma1@gmail.com') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                startApp();
            } else {
                if(user) {
                    Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô','error').then(()=>auth.signOut());
                }
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        function doLogin() {
            const e = document.getElementById('adm-email').value;
            const p = document.getElementById('adm-pass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => Swal.fire('Login Error', err.message, 'error'));
        }

        function startApp() {
            loadUsers();
            loadTransactions();
        }

        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User (‡∏ñ‡πâ‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ Error ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Rules ‡∏ú‡∏¥‡∏î)
        function loadUsers() {
            db.collection('users').onSnapshot(snap => {
                let html = '<table width="100%"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
                
                if(snap.empty) {
                    document.getElementById('user-list').innerHTML = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
                    return;
                }

                snap.forEach(doc => {
                    const u = doc.data();
                    allUsers[doc.id] = u; // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô

                    const roleBadge = u.role === 'rider' 
                        ? '<span style="background:black; color:white; padding:2px 6px; border-radius:4px;">Rider</span>' 
                        : '<span style="background:#eee; padding:2px 6px; border-radius:4px;">User</span>';

                    const bankTxt = u.bankName ? `${u.bankName} (${u.bankNo})` : '-';

                    html += `<tr>
                        <td>${u.username}<br><small style="color:grey">${u.email}</small></td>
                        <td>${roleBadge}</td>
                        <td>${u.phone || '-'}</td>
                        <td>${bankTxt}</td>
                        <td style="font-weight:bold; color:${u.balance>0?'green':'red'}">${(u.balance||0).toFixed(2)}</td>
                        <td><button class="btn btn-blue" onclick="editBal('${doc.id}', ${u.balance})">‡πÅ‡∏Å‡πâ‡πÄ‡∏á‡∏¥‡∏ô</button></td>
                    </tr>`;
                });
                
                document.getElementById('user-list').innerHTML = html + '</tbody></table>';
            }, error => {
                console.error(error);
                document.getElementById('user-list').innerHTML = `<p style="color:red">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}<br>‡πÄ‡∏ä‡πá‡∏Ñ Rules ‡∏î‡πà‡∏ß‡∏ô!</p>`;
            });
        }

        async function editBal(uid, old) {
            const {value:n} = await Swal.fire({title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô', input:'number', inputValue:old});
            if(n) {
                await db.collection('users').doc(uid).update({balance: parseFloat(n)});
                Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','','success');
            }
        }

        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
        function loadTransactions() {
            db.collection('transactions').where('status','==','pending').onSnapshot(snap => {
                const div = document.getElementById('tx-list');
                
                if(snap.empty) {
                    div.innerHTML = '<div style="padding:20px; text-align:center; color:#ccc;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</div>';
                    return;
                }

                let html = '<table width="100%"><thead><tr><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô?</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
                
                snap.forEach(doc => {
                    const t = doc.data();
                    const user = allUsers[t.uid] || {username: 'Unknown', bankName:'-', bankNo:'-'};
                    
                    const isDep = t.type === 'deposit';
                    const typeTxt = isDep ? '<b style="color:green">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</b>' : '<b style="color:red">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</b>';
                    
                    // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                    const refundInfo = !isDep ? `<span style="background:#e0f2fe; color:#0284c7; padding:3px 8px; border-radius:5px;">üè¶ ${user.bankName} - ${user.bankNo}</span>` : '-';

                    html += `<tr>
                        <td>${typeTxt}</td>
                        <td>${user.username}</td>
                        <td>${t.amount} ‡∏ö‡∏≤‡∏ó</td>
                        <td>${refundInfo}</td>
                        <td>
                            <button class="btn btn-green" onclick="processTx('${doc.id}', '${t.uid}', ${t.amount}, '${t.type}', ${t.fee||0})">‚úî ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            <button class="btn btn-red" onclick="rejectTx('${doc.id}')">‚úò ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                        </td>
                    </tr>`;
                });
                div.innerHTML = html + '</tbody></table>';
            });
        }

        async function processTx(txId, uid, amount, type, fee) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?')) return;
            
            try {
                await db.runTransaction(async t => {
                    const uRef = db.collection('users').doc(uid);
                    const txRef = db.collection('transactions').doc(txId);
                    const uDoc = await t.get(uRef);
                    
                    if(!uDoc.exists) throw "‡∏´‡∏≤ User ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠";
                    let bal = uDoc.data().balance || 0;

                    if(type === 'deposit') {
                        bal += amount;
                    } else {
                        // ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î)
                        if(bal < (amount + fee)) throw "‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å";
                        bal -= (amount + fee);
                    }

                    t.update(uRef, {balance: bal});
                    t.update(txRef, {status: 'approved'});
                });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success');
            } catch(e) { Swal.fire('Error', e.toString(), 'error'); }
        }

        async function rejectTx(id) {
            if(confirm('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) await db.collection('transactions').doc(id).update({status:'rejected'});
        }

        function show(page) {
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('page-users').style.display = page==='users'?'block':'none';
            document.getElementById('page-tx').style.display = page==='tx'?'block':'none';
        }
    </script>
</body>
</html>
